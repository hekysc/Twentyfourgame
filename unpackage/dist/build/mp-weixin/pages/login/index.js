"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/store.js"),n=require("../../utils/avatar.js"),a=require("../../utils/hints.js"),i=require("../../utils/edge-exit.js"),r=require("../../utils/navigation.js"),o=require("../../utils/useSafeArea.js"),s={__name:"index",setup(s){const c=e.ref({list:[],currentId:""}),u=e.ref(""),{hintState:d,showHint:l,hideHint:h}=a.useFloatingHint(),f=i.useEdgeExit({showHint:l,onExit:()=>{r.exitApp({fallback:()=>{try{e.index.navigateBack({delta:1})}catch(t){try{e.index.reLaunch({url:"/pages/index/index"})}catch(n){}}}})}}),{safeTop:g}=o.useSafeArea(),x=e.computed((()=>({paddingTop:`${Math.max(0,g.value||0)}px`})));function p(){try{(e.index.getSystemInfoSync&&e.index.getSystemInfoSync()||{}).windowHeight||"undefined"!=typeof window&&window.innerHeight}catch(t){}}function m(){try{const e=t.getUsers();if(!e||!Array.isArray(e.list)||void 0===e.currentId)throw new Error("本地用户数据结构无效");c.value=e}catch(e){u.value=e&&e.message?e.message:"本地存储损坏"}}e.onMounted((()=>{t.ensureInit(),m();try{p()}catch(n){}e.index.onWindowResize&&e.index.onWindowResize((()=>{try{p()}catch(n){}}))}));const v=e.computed((()=>{const e=(c.value.list||[]).filter((e=>"Guest"!==String(e.name||""))).slice();return e.sort(((e,t)=>(t.lastPlayedAt||0)-(e.lastPlayedAt||0)||(t.createdAt||0)-(e.createdAt||0))),e}));function w(t){try{e.index.reLaunch({url:t})}catch(n){try{e.index.switchTab({url:t})}catch(a){}}}function S(){e.index.showModal({title:"新建玩家",editable:!0,placeholderText:"昵称（1-20字）",success(t){if(!t.confirm)return;const n=String(t.content||"").trim();if(!n||n.length<1||n.length>20)return void e.index.showToast({title:"请输入1-20字昵称",icon:"none"});(c.value.list||[]).some((e=>String(e.name||"").toLowerCase()===n.toLowerCase()))?e.index.showModal({title:"提示",content:"已有同名玩家，是否继续创建？",success(e){e.confirm?y(n):S()}}):y(n)}})}function y(t){e.index.showActionSheet({itemList:["请选择头像方式","从相册选择","随机分配","跳过"],success(n){const a=n.tapIndex;1===a?e.index.chooseImage({count:1,sizeType:["compressed"],success(e){const n=e.tempFilePaths&&e.tempFilePaths[0]||"",a=e.tempFiles&&e.tempFiles[0]&&e.tempFiles[0].size||0;T(t,n,a)},fail(){T(t,"")}}):(2===a||3===a)&&T(t,"")},fail(){T(t,"")}})}function T(a,i,r){const o=t.addUser(a,"");i&&n.saveAvatarForUser(o,i,{size:r}).then((t=>{if(!t||!t.ok)try{e.index.showToast({title:"头像保存失败，请重试",icon:"none"})}catch(n){}})),t.switchUser(o),t.touchLastPlayed(o),w("/pages/login/index")}function A(e){if(!e)return"U";const t=String(e).trim();return t.length?t[0].toUpperCase():"U"}function b(e){if(!e)return"从未游玩";try{const t=new Date(e),n=Date.now(),a=new Date,i=t.toDateString()===a.toDateString(),r=t.getFullYear(),o=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getDate().toString().padStart(2,"0"),c=t.getHours().toString().padStart(2,"0"),u=t.getMinutes().toString().padStart(2,"0");if(i)return`今天 ${c}:${u}`;const d=new Date(n-864e5);return t.toDateString()===d.toDateString()?`昨天 ${c}:${u}`:`${r}-${o}-${s} ${c}:${u}`}catch(t){return"时间未知"}}function D(e){const t=String(e.id||e.name||"");let n=0;for(let i=0;i<t.length;i++)n=33*n+t.charCodeAt(i)>>>0;const a=["#e2e8f0","#fde68a","#bbf7d0","#bfdbfe","#fecaca","#f5d0fe","#c7d2fe"];return a[n%a.length]}function $(){e.index.showModal({title:"重置数据",content:"将清空本地所有数据，是否继续？",success(e){e.confirm&&(t.resetAllData(),u.value="",m())}})}return(n,a)=>e.e({a:u.value},u.value?{b:e.t(u.value),c:e.o($)}:0===v.value.length?{e:e.o(S)}:{f:e.f(v.value,((n,a,i)=>e.e({a:n.avatar},n.avatar?{b:n.avatar}:{c:e.t(A(n.name)),d:n.color||D(n)},{e:e.t(n.name),f:e.t(b(n.lastPlayedAt)),g:n.id,h:e.o((e=>function(e){t.switchUser(e.id),t.touchLastPlayed(e.id),w("/pages/index/index")}(n)),n.id)}))),g:e.o(S)},{d:0===v.value.length,h:e.unref(d).visible},e.unref(d).visible?{i:e.t(e.unref(d).text),j:e.o((()=>{})),k:e.unref(d).interactive?1:"",l:e.o(((...t)=>e.unref(h)&&e.unref(h)(...t)))}:{},{m:e.s(x.value),n:e.o(((...t)=>e.unref(f).handleTouchStart&&e.unref(f).handleTouchStart(...t))),o:e.o(((...t)=>e.unref(f).handleTouchMove&&e.unref(f).handleTouchMove(...t))),p:e.o(((...t)=>e.unref(f).handleTouchEnd&&e.unref(f).handleTouchEnd(...t))),q:e.o(((...t)=>e.unref(f).handleTouchCancel&&e.unref(f).handleTouchCancel(...t)))})}},c=e._export_sfc(s,[["__scopeId","data-v-8719a9a5"]]);wx.createPage(c);
