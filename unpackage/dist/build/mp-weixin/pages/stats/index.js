"use strict";const t=require("../../common/vendor.js"),e=require("../../utils/store.js");Math||(n+s)();const s=()=>"../../components/CustomTabBar.js",n=()=>"../../components/MiniBar.js",a={__name:"index",setup(s){const n=t.ref([]),a=t.ref(1);t.ref("all");const o=t.ref(""),u=t.computed((()=>n.value.map((t=>({id:t.id,name:t.name}))))),l=t.computed((()=>{var t;return(null==(t=u.value.find((t=>t.id===o.value)))?void 0:t.name)||"请选择用户"})),r=t.ref({}),c=t.computed((()=>{const t={};for(const e of n.value)t[e.id]={id:e.id,name:e.name};return t})),i=t.ref({totals:{total:0,success:0,fail:0},days:{},rounds:[],agg:{}});function f(){const t=e.allUsersWithStats();t.sort(((t,e)=>e.winRate-t.winRate||e.totals.total-t.totals.total)),n.value=t}function d(){const t={};for(const a of n.value)t[a.id]=e.readStatsExtended(a.id);r.value=t;const s=o.value;i.value=t[s]||{totals:{total:0,success:0,fail:0},days:{},rounds:[],agg:{}}}function v(t){var e;try{const s=0|(null==(e=null==t?void 0:t.detail)?void 0:e.value),n=u.value[s];n&&(o.value=n.id,d())}catch(s){}}function m(t=0){a.value=0===arguments.length?1:t}function p(){const t=Number(a.value);if(!t||t<=0)return 0;return function(){const t=new Date;return t.setHours(0,0,0,0),t.getTime()}()-864e5*(t-1)}function h(t){try{const e=new Date(t);return`${e.getMonth()+1}/${e.getDate()} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}catch(e){return"-"}}function g(t){if(!Number.isFinite(t))return"-";if(t<1e3)return t+"ms";const e=t/1e3;if(e<60)return e.toFixed(1)+"s";return`${Math.floor(e/60)}m${Math.round(e%60)}s`}t.onMounted((()=>{try{t.index.hideTabBar&&t.index.hideTabBar()}catch(s){}e.ensureInit(),f(),d()})),t.onShow((()=>{f(),d()})),t.onPullDownRefresh((()=>{try{f(),d()}finally{try{t.index.stopPullDownRefresh&&t.index.stopPullDownRefresh()}catch(e){}}}));const M=t.computed((()=>{const t=o.value;if("all"===t){const t=[];for(const e of Object.keys(r.value||{})){const s=r.value[e],n=((null==s?void 0:s.rounds)||[]).map((t=>({...t,uid:e})));t.push(...n)}return t.sort(((t,e)=>(e.ts||0)-(t.ts||0)))}return((r.value[t]||{rounds:[]}).rounds||[]).map((e=>({...e,uid:t})))})),b=t.computed((()=>{const t=M.value,e=p();return t.filter((t=>!e||(t.ts||0)>=e))})),y=t.computed((()=>b.value.slice(0,12).map((t=>({...t,user:c.value[t.uid]}))))),w=t.computed((()=>{const t=b.value,e=new Map;for(const a of t){const t=new Date(a.ts||0).toISOString().slice(0,10),s=e.get(t)||{total:0,success:0};s.total+=1,a.success&&(s.success+=1),e.set(t,s)}let s=Array.from(e.entries()).sort(((t,e)=>t[0]<e[0]?-1:1));if(a.value>0){const t=p();s=s.filter((([e])=>new Date(e+"T00:00:00Z").getTime()>=t))}s=s.slice(-30);const n=Math.max(1,...s.map((([,t])=>t.total)));return s.map((([t,e])=>{const s=Math.max(4,Math.round(e.total/n*120)),a=e.total?e.success/e.total:0,o=e.total?"#16a34a":"#e5e7eb";return{label:t,height:Math.max(6,Math.round(s*a)),color:o}}))})),x=t.computed((()=>{const t=p(),e=n.value.map((e=>{const s=((r.value[e.id]||{rounds:[],agg:{}}).rounds||[]).filter((e=>!t||(e.ts||0)>=t)),n=s.length,a=s.filter((t=>t.success)).length,o=n?Math.round(100*a/n):0,u=s.filter((t=>t.success&&Number.isFinite(t.timeMs))).map((t=>t.timeMs)),l=u.length?Math.min(...u):null,c=u.length?Math.round(u.reduce(((t,e)=>t+e),0)/u.length):null,i=n-a;return{id:e.id,name:e.name,total:n,success:a,fail:i,times:n,winRate:o,bestTimeMs:l,avgTimeMs:c}}));return e.sort(((t,e)=>e.winRate-t.winRate||e.times-t.times)),e})),T=t.computed((()=>{const t=o.value,e=t&&r.value[t]||{rounds:[]},s=p(),n=e.rounds||[];return s>0?n.filter((t=>(t.ts||0)>=s)):n.slice()}));function k(t){if(!t||"string"!=typeof t)return null;const e=t.replace(/×/g,"*").replace(/÷/g,"/").replace(/\s+/g,"");if(!/^[0-9+\-*/().]+$/.test(e))return null;try{const t=Function(`"use strict";return(${e})`)();return"number"==typeof t&&Number.isFinite(t)?t:null}catch(s){return null}}const F=t.computed((()=>{const t=[];for(const e of T.value)if(e&&!e.success&&"string"==typeof e.expr){const s=k(e.expr);if(null==s)continue;const n=s-24,a=Math.abs(n);t.push({ts:e.ts||0,expr:e.expr,value:s,diff:n,abs:a})}return t.sort(((t,e)=>t.abs-e.abs)),t.slice(0,5)}));function P(t,e){if(!t.length)return 0;return+t[Math.min(t.length-1,Math.max(0,Math.ceil(e/100*t.length)-1))].toFixed(3)}const $=t.computed((()=>{const t=[];for(const i of T.value)if(i&&!i.success&&"string"==typeof i.expr){const e=k(i.expr);if(null==e)continue;const s=e-24;t.push({abs:Math.abs(s),sign:Math.sign(s)})}const e=t.map((t=>t.abs)).sort(((t,e)=>t-e)),s=e.length;if(!s)return{count:0,median:"-",p90:"-",lt1:0,lt01:0,biasUp:0,biasDown:0};const n=P(e,50),a=P(e,90),o=Math.round(e.filter((t=>t<1)).length/s*100),u=Math.round(e.filter((t=>t<.1)).length/s*100),l=t.filter((t=>t.sign>0)).length,r=t.filter((t=>t.sign<0)).length,c=l+r;return{count:s,median:n,p90:a,lt1:o,lt01:u,biasUp:c?Math.round(100*l/c):0,biasDown:c?Math.round(100*r/c):0}})),A=t.computed((()=>{const t=["+","-","×","÷"],e=Object.fromEntries(t.map((t=>[t,{total:0,success:0}]))),s=Object.fromEntries(t.map((t=>[t,0])));for(const u of T.value){const t=Array.isArray(null==u?void 0:u.ops)?u.ops:[];if(t.length){const s=t[0];e[s]&&(e[s].total+=1,u.success&&(e[s].success+=1))}for(const e of t)null!=s[e]&&(s[e]+=1)}const n=Object.values(s).reduce(((t,e)=>t+e),0);let a=0;if(n>0)for(const u of t){const t=s[u]/n;t>0&&(a+=-t*Math.log2(t))}const o=Math.log2(4);return{first:e,allCounts:s,totalOps:n,entropy:a,entropyPct:o?Math.round(a/o*100):0}})),S=t.computed((()=>{const t=new Map,e=new Map,s=new Map,n=(t,e,s)=>{if(!e)return;const n=t.get(e)||{total:0,success:0};n.total+=1,s&&(n.success+=1),t.set(e,n)};for(const u of T.value){const a=Array.isArray(null==u?void 0:u.ops)?u.ops:[],o=!!(null==u?void 0:u.success);a.length>=2&&n(s,`${a[0]} → ${a[1]}`,o);for(let e=0;e+1<a.length;e++)n(t,`${a[e]} ${a[e+1]}`,o);for(let t=0;t+2<a.length;t++)n(e,`${a[t]} ${a[t+1]} ${a[t+2]}`,o)}const a=t=>Array.from(t.entries()).map((([t,e])=>({key:t,total:e.total,win:e.total?Math.round(100*e.success/e.total):0}))),o=(t,e)=>e.total-t.total||e.win-t.win;return{topBigrams:a(t).sort(o).slice(0,6),topTrigrams:a(e).sort(o).slice(0,6),firstTwo:a(s).sort(o).slice(0,6)}})),D=t.computed((()=>{const t=(T.value||[]).slice().sort(((t,e)=>(t.ts||0)-(e.ts||0)));let e=0,s=0,n=0,a=0;for(const o of t)o.success?(e+=1,e>s&&(s=e),n=0):(n+=1,n>a&&(a=n),e=0);return{curWin:e,maxWin:s,curLose:n,maxLose:a}})),N=t.computed((()=>{const t=T.value||[],e=t.length||1,s=(s,n,a)=>{let o=0,u=0;for(const e of t){!!a(e)&&(o+=1,e.success&&(u+=1))}return{key:s,label:n,usePct:Math.round(o/e*100),winPct:o?Math.round(u/o*100):0}},n=(t,e)=>Array.isArray(null==t?void 0:t.ops)&&t.ops.includes(e);return[s("plus","＋ 加法",(t=>n(t,"+"))),s("minus","－ 减法",(t=>n(t,"-"))),s("mul","× 乘法",(t=>n(t,"×"))),s("div","÷ 除法",(t=>n(t,"÷")||"string"==typeof(null==t?void 0:t.expr)&&t.expr.includes("/"))),s("paren","括号",(t=>"string"==typeof(null==t?void 0:t.expr)&&/[()]/.test(t.expr))),s("frac","分数",(t=>{if("string"==typeof(null==t?void 0:t.expr)&&/[.]/.test(t.expr))return!0;if("string"==typeof(null==t?void 0:t.expr)&&/[÷/]/.test(t.expr))return!0;const e="string"==typeof(null==t?void 0:t.expr)?k(t.expr):null;return null!=e&&Math.abs(e-Math.round(e))>1e-9}))]})),j=t.computed((()=>{const t=b.value,e=new Map;for(const s of t){const t=new Date(s.ts||0).toISOString().slice(0,10),n=e.get(t)||{total:0,success:0,successTimes:[]};n.total+=1,s.success&&(n.success+=1,Number.isFinite(s.timeMs)&&n.successTimes.push(s.timeMs)),e.set(t,n)}return Array.from(e.entries()).sort(((t,e)=>t[0]<e[0]?-1:1))}));function R(t){const e=j.value;if(!e.length)return{win:0,avg:"-"};const s=e.slice(-t),n=s.reduce(((t,[,e])=>t+e.total),0),a=s.reduce(((t,[,e])=>t+e.success),0),o=s.flatMap((([,t])=>t.successTimes));return{win:n?Math.round(100*a/n):0,avg:o.length?g(Math.round(o.reduce(((t,e)=>t+e),0)/o.length)):"-"}}t.computed((()=>({win7:R(7).win,win30:R(30).win,avg7:R(7).avg,avg30:R(30).avg}))),t.computed((()=>j.value.slice(-7).map((([,t])=>({rate:t.total?t.success/t.total:0}))))),t.computed((()=>j.value.slice(-30).map((([,t])=>({rate:t.total?t.success/t.total:0})))));const O=t.computed((()=>{const t=new Map;for(const s of T.value){const e=I(null==s?void 0:s.hand);if(!e)continue;const n=t.get(e)||{total:0,success:0};n.total+=1,s.success&&(n.success+=1),t.set(e,n)}const e=Array.from(t.entries()).map((([t,e])=>{const s=e.total?Math.round(100*e.success/e.total):0;return{sig:t,total:e.total,success:e.success,win:s}})).filter((t=>t.total>=2));return{top:e.slice().sort(((t,e)=>e.win-t.win||e.total-t.total)).slice(0,5),bottom:e.slice().sort(((t,e)=>t.win-e.win||e.total-t.total)).slice(0,5),minTotal:2}})),B=t.computed((()=>{const t=[],e=T.value||[],s=e.length,n=e.filter((t=>t.success)).length,a=s?100*n/s:0;A.value.entropyPct>=75?t.push("多样探索者"):A.value.entropyPct<=35&&t.push("单核惯性");const o=Math.max(1,A.value.totalOps);(A.value.allCounts["×"]||0)/o>=.4&&t.push("乘法信徒"),$.value.count>0&&$.value.lt1>=50&&t.push("精准狙击");const u=(N.value||[]).find((t=>"frac"===t.key));u&&u.usePct>0&&a-u.winPct>=20&&t.push("分数恐惧症");const l=e.filter((t=>t.success&&Number.isFinite(t.retries)&&t.retries>0)).length,r=e.filter((t=>t.success)).length||1;l/r>=.5&&r>=4&&t.push("逆转之王");const c=e.filter((t=>t.success&&Number.isFinite(t.timeMs))).map((t=>t.timeMs));(c.length?Math.min(...c):1/0)<=1500&&t.push("极速手");return(e.filter((t=>Number.isFinite(t.retries))).reduce(((t,e)=>t+e.retries),0)/Math.max(1,e.filter((t=>Number.isFinite(t.retries))).length)||0)>=1&&a>=50&&t.push("磨刀匠"),t}));function I(t){try{const e=t&&Array.isArray(t.cards)?t.cards:[];return e.map((t=>+t.rank)).filter((t=>Number.isFinite(t))).sort(((t,e)=>t-e)).join(",")}catch(e){return""}}const W=t.computed((()=>{const t=new Map;for(const s of T.value){const e=I(null==s?void 0:s.hand);if(!e)continue;const n=t.get(e)||{total:0,success:0};n.total+=1,s.success&&(n.success+=1),t.set(e,n)}const e=Array.from(t.entries()).map((([t,e])=>{const s=e.total?Math.round(100*e.success/e.total):0;return{sig:t,total:e.total,success:e.success,win:s}}));return e.sort(((t,e)=>e.total-t.total||e.win-t.win)),e.slice(0,5)})),_=t.computed((()=>{const t=[{key:"<1s",min:0,max:1e3},{key:"1-2s",min:1e3,max:2e3},{key:"2-5s",min:2e3,max:5e3},{key:"5-10s",min:5e3,max:1e4},{key:"10-30s",min:1e4,max:3e4},{key:"≥30s",min:3e4,max:1/0}],e=t.map((t=>({label:t.key,total:0,success:0,fail:0})));for(const s of T.value){if(!Number.isFinite(null==s?void 0:s.timeMs))continue;const n=s.timeMs,a=t.findIndex((t=>n>=t.min&&n<t.max));a<0||(e[a].total+=1,s.success?e[a].success+=1:e[a].fail+=1)}return e}));return(e,s)=>t.e({a:1===a.value?1:"",b:t.o((t=>m(1))),c:3===a.value?1:"",d:t.o((t=>m(3))),e:7===a.value?1:"",f:t.o((t=>m(7))),g:30===a.value?1:"",h:t.o((t=>m(30))),i:0===a.value?1:"",j:t.o((t=>m(0))),k:t.f(x.value,((e,s,n)=>({a:t.t(s+1),b:t.t(e.name),c:t.t(e.times),d:t.t(e.success),e:t.t(e.fail),f:t.t(e.winRate),g:t.t(null!=e.avgTimeMs?g(e.avgTimeMs):"-"),h:t.t(null!=e.bestTimeMs?g(e.bestTimeMs):"-"),i:e.id,j:t.o((s=>function(e){o.value=e||"",d();try{t.index.pageScrollTo&&t.index.pageScrollTo({selector:".trend",duration:200})}catch(s){}}(e.id)),e.id)}))),l:o.value},o.value?{m:t.t(l.value),n:u.value,o:t.o(v),p:t.f(w.value,((t,e,s)=>({a:e,b:(t.height||4)+"rpx",c:t.color}))),q:t.t(D.value.curWin),r:t.t(D.value.maxWin),s:t.t(D.value.curLose),t:t.t(D.value.maxLose)}:{},{v:o.value},o.value?{w:t.f(y.value,((e,s,n)=>({a:t.t(h(e.ts)),b:t.t(e.success?"成功":"失败"),c:e.success?1:"",d:e.success?"":1,e:t.t(null!=e.timeMs&&Number.isFinite(e.timeMs)?(e.timeMs/1e3).toFixed(1)+"s":"-"),f:e.id})))}:{},{x:o.value},o.value?t.e({y:F.value.length},F.value.length?{z:t.f(F.value,((e,s,n)=>({a:t.t(h(e.ts)),b:t.t(e.expr),c:t.t(e.value),d:t.t(e.diff>0?"+"+e.diff.toFixed(3):e.diff.toFixed(3)),e:e.diff>0?"#2563eb":"#dc2626",f:s})))}:{},{A:t.t($.value.count),B:t.t($.value.median),C:t.t($.value.p90),D:t.t($.value.lt1),E:t.t($.value.lt01),F:t.t($.value.biasUp),G:t.t($.value.biasDown)}):{},{H:o.value},o.value?{I:t.t(A.value.entropyPct),J:t.f(["+","-","×","÷"],((e,s,n)=>({a:t.t(e),b:t.t(A.value.allCounts[e]),c:t.t(A.value.first[e].total),d:t.t(A.value.first[e].total?Math.round(100*A.value.first[e].success/A.value.first[e].total):0),e:"e1f0ada9-0-"+n,f:t.p({pct:A.value.first[e].total?Math.round(100*A.value.first[e].success/A.value.first[e].total):0}),g:e}))),K:t.f(S.value.topBigrams,((e,s,n)=>({a:t.t(e.key),b:t.t(e.total),c:t.t(e.win),d:"b-"+e.key}))),L:t.f(S.value.topTrigrams,((e,s,n)=>({a:t.t(e.key),b:t.t(e.total),c:t.t(e.win),d:"t-"+e.key}))),M:t.f(S.value.firstTwo,((e,s,n)=>({a:t.t(e.key),b:t.t(e.total),c:t.t(e.win),d:"f2-"+e.key})))}:{},{N:o.value},o.value?t.e({O:W.value.length},W.value.length?{P:t.f(W.value,((e,s,n)=>({a:t.t(e.sig),b:t.t(e.total),c:t.t(e.success),d:t.t(e.win),e:e.sig})))}:{}):{},{Q:o.value},o.value?{R:t.t(O.value.minTotal),S:t.f(O.value.top,((e,s,n)=>({a:t.t(e.sig),b:t.t(e.total),c:t.t(e.win),d:"top-"+e.sig}))),T:t.f(O.value.bottom,((e,s,n)=>({a:t.t(e.sig),b:t.t(e.total),c:t.t(e.win),d:"bot-"+e.sig})))}:{},{U:o.value},o.value?{V:t.f(B.value,((e,s,n)=>({a:t.t(e),b:s})))}:{},{W:o.value},o.value?{X:t.f(_.value,((e,s,n)=>({a:t.t(e.label),b:t.t(e.total),c:t.t(e.success),d:t.t(e.fail),e:"e1f0ada9-1-"+n,f:t.p({pct:e.total?Math.round(100*e.success/e.total):0}),g:e.label})))}:{},{Y:o.value},o.value?{Z:t.f(N.value,((e,s,n)=>({a:t.t(e.label),b:t.t(e.usePct),c:t.t(e.winPct),d:e.key})))}:{})}},o=t._export_sfc(a,[["__scopeId","data-v-e1f0ada9"]]);wx.createPage(o);
