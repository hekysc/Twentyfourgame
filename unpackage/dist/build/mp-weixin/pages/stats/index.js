"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/store.js"),a=require("../../utils/mistakes.js"),r=require("../../utils/hints.js"),n=require("../../utils/edge-exit.js"),s=require("../../utils/avatar.js"),u=require("../../utils/navigation.js"),i=require("../../utils/stats.js"),o=require("../../utils/useSafeArea.js"),l=require("../../utils/tab-cache.js");Math||(d+c)();const c=()=>"../../components/CustomTabBar.js",d=()=>"../../components/MiniBar.js",v={__name:"index",setup(c){const{safeTop:d,safeBottom:v}=o.useSafeArea(),f=o.rpxToPx(24)||12,p=o.rpxToPx(120)||60,h=e.ref(l.getTabBarHeight()||p),m=e.computed((()=>{const e=Math.max(0,d.value||0),t=Math.max(0,v.value||0),a=h.value||p;return{paddingTop:`${e+f}px`,paddingLeft:`${f}px`,paddingRight:`${f}px`,paddingBottom:`${f+t+a}px`,display:"flex",flexDirection:"column",rowGap:"18rpx",backgroundColor:"#f8fafc",boxSizing:"border-box",minHeight:"calc(var(--vh, 1vh) * 100)"}})),g=e.ref([]),y=e.ref(1);e.ref("all");const x=e.ref(""),b=e.computed((()=>g.value.map((e=>({id:e.id,name:e.name}))))),M=e.computed((()=>{var e;return(null==(e=b.value.find((e=>e.id===x.value)))?void 0:e.name)||"请选择用户"})),w=e.ref({}),S=e.computed((()=>{const e={};for(const t of g.value)e[t.id]={id:t.id,name:t.name};return e})),{hintState:T,showHint:k,hideHint:A}=r.useFloatingHint(),N=n.useEdgeExit({showHint:k,onExit:()=>{u.exitApp({fallback:()=>{try{if("function"==typeof e.index.switchTab)return void e.index.switchTab({url:"/pages/index/index"})}catch(t){}try{if("function"==typeof e.index.reLaunch)return void e.index.reLaunch({url:"/pages/index/index"})}catch(t){}}})}}),C=e.ref({totals:{total:0,success:0,fail:0},days:{},rounds:[],agg:{}}),F=e.computed((()=>{var e,t;try{return((null==(t=null==(e=X.value)?void 0:e.items)?void 0:t.length)||0)>=1}catch(a){return!1}})),j=e.ref({active:{},ledger:{}}),_=e.ref({totalWrongCount:0,totalActiveCount:0}),R=e.ref(!0),H=e.computed((()=>{const e=j.value||{active:{},ledger:{}},t=e.ledger||{},a=new Set(Object.keys(e.active||{})),r=[];for(const n of Object.keys(t)){const e=t[n]||{},s=Number.isFinite(e.attempts)?Math.max(0,Math.floor(e.attempts)):0,u=Number.isFinite(e.wrong)?Math.max(0,Math.floor(e.wrong)):0,i=Number.isFinite(e.correct)?Math.max(0,Math.floor(e.correct)):0,o=s||u+i,l=o?Math.round(u/o*100):0,c=Number.isFinite(e.streakCorrect)?Math.max(0,Math.floor(e.streakCorrect)):0,d=Number.isFinite(e.lastSeenTs)?Math.floor(e.lastSeenTs):0,v=Array.isArray(e.nums)?e.nums:"string"==typeof n?n.split(",").map((e=>+e||0)):[];r.push({key:e.key||n,displayKey:e.key||n||v.join(","),nums:v,attempts:o,wrong:u,correct:i,errorRate:l,streak:c,active:a.has(n),lastSeenTs:d,lastSeenText:d?z(d):"-"})}return r.sort(((e,t)=>t.lastSeenTs-e.lastSeenTs)),r})),$=e.computed((()=>{const e=H.value.slice(),t=R.value?e.filter((e=>e.active)):e;return t.sort(((e,t)=>t.attempts-e.attempts||t.wrong-e.wrong||t.lastSeenTs-e.lastSeenTs)),t}));function P(){let a=l.getCachedOverviewRows();a=Array.isArray(a)&&a.length?a.map((e=>({...e}))):t.allUsersWithStats(),a.sort(((e,t)=>t.winRate-e.winRate||t.totals.total-e.totals.total)),g.value=a,l.setCachedOverviewRows(a),function(a){const r=Array.isArray(a)?a:[];if(!r.length)return x.value&&(x.value=""),void W("");const n=x.value;if(n&&r.some((e=>e.id===n)))return void W(n);const s=function(a){var r;const n=Array.isArray(a)?a:[];if(!n.length)return"";const s=function(){try{if(void 0!==e.index&&"function"==typeof e.index.getStorageSync){const t=e.index.getStorageSync("tf24_stats_selected_user_v1");return"string"==typeof t?t:""}}catch(t){}return""}();if(s&&n.some((e=>e.id===s)))return s;const u=t.getCurrentUser();return u&&n.some((e=>e.id===u.id))?u.id:(null==(r=n[0])?void 0:r.id)||""}(r);s&&n!==s?x.value=s:!s&&n&&(x.value="");W(s)}(a)}function O(){const e={},a={};for(const n of g.value){if(!n||!n.id)continue;const r=l.getCachedStatsExt(n.id);if(r){e[n.id]=r;continue}const s=t.readStatsExtended(n.id);e[n.id]=s,a[n.id]=s}Object.keys(a).length&&l.mergeCachedStatsExt(a),w.value=e;const r=x.value;C.value=e[r]||{totals:{total:0,success:0,fail:0},days:{},rounds:[],agg:{}},D()}function D(){const e=x.value;if(!e)return j.value={active:{},ledger:{}},void(_.value={totalWrongCount:0,totalActiveCount:0});try{j.value=a.loadMistakeBook(e),_.value=a.getSummary(e)}catch(t){j.value={active:{},ledger:{}},_.value={totalWrongCount:0,totalActiveCount:0}}}function W(t){try{t?void 0!==e.index&&"function"==typeof e.index.setStorageSync&&e.index.setStorageSync("tf24_stats_selected_user_v1",t):void 0!==e.index&&"function"==typeof e.index.removeStorageSync&&e.index.removeStorageSync("tf24_stats_selected_user_v1")}catch(a){}}function q(e){var t;try{const a=0|(null==(t=null==e?void 0:e.detail)?void 0:t.value),r=b.value[a];r&&(x.value=r.id,W(r.id),O())}catch(a){}}function B(e=0){y.value=0===arguments.length?1:e}function E(e){var t;R.value=!!(null==(t=null==e?void 0:e.detail)?void 0:t.value)}function L(){const e=new Date;return e.setHours(0,0,0,0),e.getTime()}function K(){const e=Number(y.value);if(!e||e<=0)return 0;return L()-864e5*(e-1)}function z(e){try{const t=new Date(e);return`${t.getMonth()+1}/${t.getDate()} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}catch(t){return"-"}}function J(e){if(!Number.isFinite(e))return"-";if(e<1e3)return e+"ms";const t=e/1e3;if(t<60)return t.toFixed(1)+"s";return`${Math.floor(t/60)}m${Math.round(t%60)}s`}function U(e){if(Number.isFinite(e))return e;const t=Number(e);if(Number.isFinite(t))return t;if("string"==typeof e){const t=e.trim().toUpperCase();if("A"===t)return 1;if("J"===t)return 11;if("Q"===t)return 12;if("K"===t)return 13}return null}function I(e){try{const t=function(e){return e&&"object"==typeof e?Array.isArray(e.cards)?e.cards.map(U).filter((e=>Number.isFinite(e))):e.hand&&Array.isArray(e.hand.cards)?e.hand.cards.map((e=>U(null==e?void 0:e.rank))).filter((e=>Number.isFinite(e))):Array.isArray(e.nums)?e.nums.map(U).filter((e=>Number.isFinite(e))):[]:[]}(e);return t.length?t.map((e=>String(Math.trunc(e)))).join(","):"-"}catch(t){return"-"}}e.onMounted((()=>{try{e.index.hideTabBar&&e.index.hideTabBar()}catch(a){}t.ensureInit(),h.value=l.getTabBarHeight()||h.value,P(),O(),s.consumeAvatarRestoreNotice()&&k("头像文件丢失，已为你恢复为默认头像",2e3)})),e.onShow((()=>{P(),O(),h.value=l.getTabBarHeight()||h.value;try{e.index.$emit&&e.index.$emit("tabbar:update")}catch(t){}s.consumeAvatarRestoreNotice()&&k("头像文件丢失，已为你恢复为默认头像",2e3)})),e.onPullDownRefresh((()=>{try{P(),O()}finally{try{e.index.stopPullDownRefresh&&e.index.stopPullDownRefresh()}catch(t){}}})),e.watch(x,((e,t)=>{e!==t&&(R.value=!0),D(),W(e||"")}));const G=e.computed((()=>{const e=x.value;if("all"===e){const e=[];for(const t of Object.keys(w.value||{})){const a=w.value[t],r=((null==a?void 0:a.rounds)||[]).map((e=>({...e,uid:t})));e.push(...r)}return e.sort(((e,t)=>(t.ts||0)-(e.ts||0)))}return((w.value[e]||{rounds:[]}).rounds||[]).map((t=>({...t,uid:e})))})),Q=e.computed((()=>{const e=G.value,t=K();return e.filter((e=>!t||(e.ts||0)>=t))})),Y=e.computed((()=>Q.value.slice().sort(((e,t)=>(t.ts||0)-(e.ts||0))).slice(0,12).map((e=>({...e,user:S.value[e.uid],cardsText:I(e)}))).reverse()));function V(e){const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}const X=e.computed((()=>{const e=Q.value,t=new Map;for(const o of e){const e=V(o.ts||0),a=t.get(e)||{total:0,success:0};a.total+=1,o.success&&(a.success+=1),t.set(e,a)}const a=L(),r=V(a);let n=[];if(y.value>0){for(let e=a-864e5*((Number(y.value)||1)-1);e<=a;e+=864e5)n.push(V(e))}else n=Array.from(t.keys()),n.includes(r)||n.push(r),n.sort(),n.length>30&&(n=n.slice(-30));const s=n.map((e=>{const a=t.get(e)||{total:0,success:0},r=a.total||0,n=a.success||0;return{key:e,total:r,success:n,winRate:r?n/r:0}})),u=Math.max(1,...s.map((e=>e.total))),i=s.map((e=>{const t=e.total?Math.max(4,Math.round(e.total/u*160)):0,a=e.total?Math.round(t*e.winRate):0,r=Math.max(0,t-a);return{label:e.key,shortLabel:(n=e.key,n?n.slice(5).replace("-","/"):""),totalHeight:t,successHeight:a,failHeight:r};var n}));return{items:i,barWidth:24,gap:12,chartHeight:160,width:i.length?36*i.length-12:0}})),Z=e.computed((()=>i.computeOverviewRows(g.value,w.value,K()))),ee=e.computed((()=>{const e=x.value,t=e&&w.value[e]||{rounds:[]},a=K(),r=t.rounds||[];return a>0?r.filter((e=>(e.ts||0)>=a)):r.slice()}));const te=e.computed((()=>i.summarizeNearMisses(ee.value))),ae=e.computed((()=>{const e=["+","-","×","÷"],t=Object.fromEntries(e.map((e=>[e,{total:0,success:0}]))),a=Object.fromEntries(e.map((e=>[e,0])));for(const u of ee.value){const e=Array.isArray(null==u?void 0:u.ops)?u.ops:[];if(e.length){const a=e[0];t[a]&&(t[a].total+=1,u.success&&(t[a].success+=1))}for(const t of e)null!=a[t]&&(a[t]+=1)}const r=Object.values(a).reduce(((e,t)=>e+t),0);let n=0;if(r>0)for(const u of e){const e=a[u]/r;e>0&&(n+=-e*Math.log2(e))}const s=Math.log2(4);return{first:t,allCounts:a,totalOps:r,entropy:n,entropyPct:s?Math.round(n/s*100):0}})),re=e.computed((()=>{const e=(ee.value||[]).slice().sort(((e,t)=>(e.ts||0)-(t.ts||0)));let t=0,a=0,r=0,n=0;for(const s of e)s.success?(t+=1,t>a&&(a=t),r=0):(r+=1,r>n&&(n=r),t=0);return{curWin:t,maxWin:a,curLose:r,maxLose:n}})),ne=e.computed((()=>{const e=ee.value||[],t=e.length||1,a=(a,r,n)=>{let s=0,u=0;for(const t of e){!!n(t)&&(s+=1,t.success&&(u+=1))}return{key:a,label:r,usePct:Math.round(s/t*100),winPct:s?Math.round(u/s*100):0}},r=(e,t)=>Array.isArray(null==e?void 0:e.ops)&&e.ops.includes(t);return[a("plus","＋ 加法",(e=>r(e,"+"))),a("minus","－ 减法",(e=>r(e,"-"))),a("mul","× 乘法",(e=>r(e,"×"))),a("div","÷ 除法",(e=>r(e,"÷")||"string"==typeof(null==e?void 0:e.expr)&&e.expr.includes("/"))),a("paren","括号",(e=>"string"==typeof(null==e?void 0:e.expr)&&/[()]/.test(e.expr))),a("frac","分数",(e=>{if("string"==typeof(null==e?void 0:e.expr)&&/[.]/.test(e.expr))return!0;if("string"==typeof(null==e?void 0:e.expr)&&/[÷/]/.test(e.expr))return!0;const t="string"==typeof(null==e?void 0:e.expr)?function(e){if(!e||"string"!=typeof e)return null;const t=e.replace(/×/g,"*").replace(/÷/g,"/").replace(/\s+/g,"");if(!/^[0-9+\-*/().]+$/.test(t))return null;try{const e=Function(`"use strict";return(${t})`)();return"number"==typeof e&&Number.isFinite(e)?e:null}catch(a){return null}}(e.expr):null;return null!=t&&Math.abs(t-Math.round(t))>1e-9}))]})),se=e.computed((()=>i.computeDailySeries(Q.value)));function ue(e){const t=se.value;if(!t.length)return{win:0,avg:"-"};const a=t.slice(-e),r=a.reduce(((e,[,t])=>e+t.total),0),n=a.reduce(((e,[,t])=>e+t.success),0),s=a.flatMap((([,e])=>e.successTimes));return{win:r?Math.round(100*n/r):0,avg:s.length?J(Math.round(s.reduce(((e,t)=>e+t),0)/s.length)):"-"}}e.computed((()=>({win7:ue(7).win,win30:ue(30).win,avg7:ue(7).avg,avg30:ue(30).avg})));const ie=e.computed((()=>{const e=[],t=ee.value||[],a=t.length,r=t.filter((e=>e.success)).length,n=a?100*r/a:0;ae.value.entropyPct>=75?e.push("多样探索者"):ae.value.entropyPct<=35&&e.push("单核惯性");const s=Math.max(1,ae.value.totalOps);(ae.value.allCounts["×"]||0)/s>=.4&&e.push("乘法信徒"),te.value.count>0&&te.value.lt1>=50&&e.push("精准狙击");const u=(ne.value||[]).find((e=>"frac"===e.key));u&&u.usePct>0&&n-u.winPct>=20&&e.push("分数恐惧症");const i=t.filter((e=>e.success&&Number.isFinite(e.retries)&&e.retries>0)).length,o=t.filter((e=>e.success)).length||1;i/o>=.5&&o>=4&&e.push("逆转之王");const l=t.filter((e=>e.success&&Number.isFinite(e.timeMs))).map((e=>e.timeMs));(l.length?Math.min(...l):1/0)<=1500&&e.push("极速手");return(t.filter((e=>Number.isFinite(e.retries))).reduce(((e,t)=>e+t.retries),0)/Math.max(1,t.filter((e=>Number.isFinite(e.retries))).length)||0)>=1&&n>=50&&e.push("磨刀匠"),e})),oe=e.computed((()=>i.computeSpeedBuckets(ee.value).map((e=>{const t=e.total||0,a=e.success||0,r=e.fail||0,n=Number.isFinite(e.avgTimeMs)?e.avgTimeMs:null,s=t?Math.round(a/t*100):0;return{label:e.label,total:t,success:a,fail:r,successRate:s,avgTimeMs:n,avgTimeText:null!=n?J(n):"-"}})))),le=e.ref("winRate"),ce=e.ref("desc");try{const t=e.index.getStorageSync&&e.index.getStorageSync("tf24_overview_sort_v1"),a=t&&("string"==typeof t?JSON.parse(t):t);a&&a.key&&a.dir&&("asc"===a.dir||"desc"===a.dir)&&(le.value=a.key,ce.value=a.dir)}catch(fe){}function de(t){const a="name"===t||"avgTimeMs"===t||"bestTimeMs"===t?"asc":"desc";le.value!==t?(le.value=t,ce.value=a):ce.value="asc"===ce.value?"desc":"asc",function(){try{e.index.setStorageSync&&e.index.setStorageSync("tf24_overview_sort_v1",JSON.stringify({key:le.value,dir:ce.value}))}catch(fe){}}()}const ve=e.computed((()=>{try{const e=[...Array.isArray(Z)?Z:(null==Z?void 0:Z.value)||[]],t=le.value,a="asc"===ce.value?1:-1;return e.sort(((e,r)=>{const n=null==e?void 0:e[t],s=null==r?void 0:r[t];if("name"===t){const e=String(n||""),t=String(s||"");return e.localeCompare(t,"zh")*a}const u=Number.isFinite(n)?n:-1/0,i=Number.isFinite(s)?s:-1/0;return u===i?0:(u>i?1:-1)*a})),e}catch(fe){return[]}}));return(t,a)=>e.e({a:1===y.value?1:"",b:e.o((e=>B(1))),c:3===y.value?1:"",d:e.o((e=>B(3))),e:7===y.value?1:"",f:e.o((e=>B(7))),g:30===y.value?1:"",h:e.o((e=>B(30))),i:0===y.value?1:"",j:e.o((e=>B(0))),k:e.o((e=>de("name"))),l:"name"===le.value?1:"",m:e.o((e=>de("times"))),n:"times"===le.value?1:"",o:e.o((e=>de("success"))),p:"success"===le.value?1:"",q:e.o((e=>de("winRate"))),r:"winRate"===le.value?1:"",s:e.o((e=>de("avgTimeMs"))),t:"avgTimeMs"===le.value?1:"",v:e.o((e=>de("bestTimeMs"))),w:"bestTimeMs"===le.value?1:"",x:e.f(ve.value,((t,a,r)=>({a:e.t(a+1),b:e.t(t.name),c:e.t(t.times),d:e.t(t.success),e:e.t(t.fail),f:e.t(t.winRate),g:e.t(null!=t.avgTimeMs?J(t.avgTimeMs):"-"),h:e.t(null!=t.bestTimeMs?J(t.bestTimeMs):"-"),i:t.id,j:e.o((e=>{return a=t.id,x.value=a||"",W(x.value),void O();var a}),t.id)}))),y:x.value},x.value?{z:e.t(M.value),A:b.value,B:e.o(q)}:{},{C:x.value},x.value?{D:e.f(X.value.items,((e,t,a)=>({a:e.failHeight+"rpx",b:e.successHeight+"rpx",c:e.totalHeight+"rpx",d:e.label||t}))),E:X.value.barWidth+"rpx",F:X.value.gap+"rpx",G:X.value.width?X.value.width+"rpx":"100%",H:X.value.width?X.value.width+"rpx":"100%",I:X.value.chartHeight+"rpx",J:e.f(X.value.items,((t,a,r)=>({a:e.t(t.shortLabel),b:"label-"+a}))),K:X.value.barWidth+"rpx",L:F.value?1:"",M:X.value.gap+"rpx",N:X.value.width?X.value.width+"rpx":"100%",O:e.t(re.value.curWin),P:e.t(re.value.maxWin),Q:e.t(re.value.curLose),R:e.t(re.value.maxLose)}:{},{S:x.value},x.value?e.e({T:Y.value.length},Y.value.length?{U:e.f((Y.value||[]).slice().reverse(),((t,a,r)=>({a:e.t(z(t.ts)),b:e.t(t.success?"成功":"失败"),c:t.success?1:"",d:t.success?"":1,e:e.t(null!=t.timeMs&&Number.isFinite(t.timeMs)?(t.timeMs/1e3).toFixed(1)+"s":"-"),f:e.t(t.cardsText),g:t.id})))}:{}):{},{V:x.value},x.value?e.e({W:e.t(_.value.totalWrongCount),X:e.t(_.value.totalActiveCount),Y:R.value,Z:e.o(E),aa:$.value.length},$.value.length?{ab:e.f($.value,((t,a,r)=>({a:e.t(t.displayKey),b:e.o((a=>function(t){try{const a="string"==typeof(null==t?void 0:t.displayKey)&&t.displayKey.trim()?t.displayKey:"string"==typeof(null==t?void 0:t.key)?t.key:"";if(!a)return;const r=()=>{try{void 0!==e.index&&"function"==typeof e.index.showToast?e.index.showToast({title:"题目 key 已复制",icon:"none"}):k("题目 key 已复制",1200)}catch(fe){k("题目 key 已复制",1200)}},n=()=>{k("复制失败，请手动选择",1500)};if(void 0!==e.index&&"function"==typeof e.index.setClipboardData)return void e.index.setClipboardData({data:a,success:r,fail:n});if("undefined"!=typeof navigator&&navigator.clipboard&&"function"==typeof navigator.clipboard.writeText)return void navigator.clipboard.writeText(a).then(r).catch(n);n()}catch(fe){k("复制失败，请重试",1500)}}(t)),t.key),c:e.t(t.attempts),d:e.t(t.wrong),e:e.t(t.correct),f:e.t(t.active?"是":"否"),g:t.active?1:"",h:t.key})))}:{ac:e.t(R.value?"当前无活动错题":"暂无错题记录")}):{},{ad:x.value},x.value?{ae:e.f(ie.value,((t,a,r)=>({a:e.t(t),b:a})))}:{},{af:x.value},x.value?{ag:e.f(oe.value,((t,a,r)=>({a:e.t(t.label),b:e.t(t.total),c:e.t(t.success),d:e.t(t.fail),e:"7a220b88-0-"+r,f:e.p({pct:t.successRate}),g:e.t(t.avgTimeText),h:t.label})))}:{},{ah:x.value},x.value?{ai:e.f(ne.value,((t,a,r)=>({a:e.t(t.label),b:e.t(t.usePct),c:e.t(t.winPct),d:t.key})))}:{},{aj:e.unref(T).visible},e.unref(T).visible?{ak:e.t(e.unref(T).text),al:e.o((()=>{})),am:e.unref(T).interactive?1:"",an:e.o(((...t)=>e.unref(A)&&e.unref(A)(...t)))}:{},{ao:e.s(m.value),ap:e.o(((...t)=>e.unref(N).handleTouchStart&&e.unref(N).handleTouchStart(...t))),aq:e.o(((...t)=>e.unref(N).handleTouchMove&&e.unref(N).handleTouchMove(...t))),ar:e.o(((...t)=>e.unref(N).handleTouchEnd&&e.unref(N).handleTouchEnd(...t))),as:e.o(((...t)=>e.unref(N).handleTouchCancel&&e.unref(N).handleTouchCancel(...t)))})}},f=e._export_sfc(v,[["__scopeId","data-v-7a220b88"]]);wx.createPage(f);
