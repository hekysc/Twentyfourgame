"use strict";const e=require("../../common/vendor.js"),t=require("../../utils/solver.js"),a=require("../../utils/store.js");Math||n();const n=()=>"../../components/CustomTabBar.js",u={__name:"index",setup(n){const u=e.ref([{rank:1,suit:"S"},{rank:5,suit:"H"},{rank:5,suit:"D"},{rank:5,suit:"C"}]),l=e.ref(null),o=e.ref(""),r=e.ref([0,0,0,0]),i=e.ref([]),c=e.ref(!1),s=e.ref(!1),v=e.ref(200),d=e.ref(null),f=e.ref([]),h=e.ref(0),p=e.ref(0),x=e.ref(0);e.ref(!1);const m=e.ref(!1),y=e.ref(!1),g=e.ref(!1),k=e.ref(""),w=e.ref(Date.now()),S=e.ref(Date.now()),T=e.ref(!1),M=e.ref(0),b=e.ref(null);function C(){try{const t={deck:f.value||[],cards:u.value||[],tokens:(i.value||[]).map((e=>({type:e.type,value:e.value,rank:e.rank,suit:e.suit}))),usedByCard:r.value||[],faceUseHigh:!!c.value,handRecorded:!!s.value,handStartTs:w.value||0,hintWasUsed:!!T.value,attemptCount:M.value||0,handsPlayed:h.value||0,successCount:p.value||0,failCount:x.value||0,feedback:o.value||""};e.index.setStorageSync("tf24_game_session_v1",JSON.stringify(t))}catch(t){}}function D(){try{const t=e.index.getStorageSync("tf24_game_session_v1");if(!t)return!1;const a="string"==typeof t?JSON.parse(t):t;return!!(a&&Array.isArray(a.deck)&&Array.isArray(a.cards))&&(4===(a.cards||[]).length&&(f.value=a.deck,u.value=a.cards,i.value=Array.isArray(a.tokens)?a.tokens:[],r.value=Array.isArray(a.usedByCard)?a.usedByCard:[0,0,0,0],c.value=!!a.faceUseHigh,s.value=!!a.handRecorded,w.value=a.handStartTs||Date.now(),T.value=!!a.hintWasUsed,M.value=a.attemptCount||0,h.value=a.handsPlayed||0,p.value=a.successCount||0,x.value=a.failCount||0,o.value=a.feedback||"",e.nextTick$1((()=>{me(),he(),ye()})),!0))}catch(t){return!1}}const R=e.computed((()=>(f.value||[]).length)),$=e.computed((()=>{const e=p.value+x.value;return e?Math.round(100*p.value/e):0})),U=e.computed((()=>{const e=w.value||Date.now(),t=(S.value||Date.now())-e;return t>0?t:0}));let A=null;function I(){if(!A)try{A=setInterval((()=>{S.value=Date.now()}),100)}catch(e){A=null}}function H(){if(A){try{clearInterval(A)}catch(e){}A=null}}const L=e.ref({active:!1,token:null,x:0,y:0,startX:0,startY:0,moved:!1}),_=e.ref({left:0,top:0,right:0,bottom:0}),F=e.ref([]),j=e.ref(-1),B=e.ref(-1),{proxy:E}=e.getCurrentInstance(),J=e.ref(!1),Q=e.computed((()=>i.value.map((e=>"num"===e.type?String(ge(e.rank??+e.value)):e.value)).join(""))),q=e.computed((()=>`left:${L.value.x}px; top:${L.value.y}px;`)),K=e.ref(1),N=e.ref("normal"),z=e.computed((()=>"tight"===N.value?"ops-tight":"compact"===N.value?"ops-compact":"")),P=e.computed((()=>{const e=L.value.token;return e?"num"===e.type?ke(e.rank||+e.value):"tok"===e.type?/^(10|11|12|13|[1-9])$/.test(e.value)?ke(+e.value):e.value:e.value||"":""})),W=e.computed((()=>{const e=L.value.token;return L.value.active&&e?"num"===e.type?"num":"op"===e.type?"op":"tok"===e.type&&/^(10|11|12|13|[1-9])$/.test(e.value)?"num":"op":"op"}));function X(){const e=["S","H","D","C"],t=[];for(const a of e)for(let e=1;e<=13;e++)t.push({rank:e,suit:a});for(let a=t.length-1;a>0;a--){const e=Math.floor(Math.random()*(a+1));[t[a],t[e]]=[t[e],t[a]]}f.value=t}function Y(){if(!f.value||f.value.length<4){try{e.index.showModal({title:"牌库用尽",content:"余牌无解或整副用完，是否重新洗牌？",confirmText:"重洗",cancelText:"进入统计",success:t=>{if(t.confirm)X(),h.value=0,p.value=0,x.value=0,e.nextTick$1((()=>Y()));else try{e.index.reLaunch({url:"/pages/stats/index"})}catch(a){try{e.index.navigateTo({url:"/pages/stats/index"})}catch(n){}}}})}catch(d){X(),h.value=0,p.value=0,x.value=0,e.nextTick$1((()=>Y()))}return}const a=Math.min(200,1+f.value.length*f.value.length);let n=null;for(let e=0;e<a;e++){const e=new Set;for(;e.size<4;)e.add(Math.floor(Math.random()*f.value.length));const a=Array.from(e),u=a.map((e=>f.value[e])).map((e=>ge(e.rank))),l=t.solve24(u);if(l){n={ids:a,sol:l};break}}if(!n){try{e.index.showModal({title:"牌库用尽",content:"余牌无解或整副用完，是否重新洗牌？",confirmText:"重洗",cancelText:"进入统计",success:t=>{if(t.confirm)X(),h.value=0,p.value=0,x.value=0,e.nextTick$1((()=>Y()));else try{e.index.reLaunch({url:"/pages/stats/index"})}catch(a){try{e.index.navigateTo({url:"/pages/stats/index"})}catch(d){}}}})}catch(d){X(),h.value=0,p.value=0,x.value=0,e.nextTick$1((()=>Y()))}return}const c=n.ids.sort(((e,t)=>t-e)),v=[];for(const e of c)v.unshift(f.value[e]),f.value.splice(e,1);u.value=v,l.value=n.sol,i.value=[],r.value=[0,0,0,0],s.value=!1,w.value=Date.now(),T.value=!1,M.value=0,o.value="拖入 + - × ÷ ( ) 组成 24",e.nextTick$1((()=>ye()));try{C()}catch(d){}}function Z(){const e=i.value||[],t=[];let a=0,n=0;for(const u of e)if("op"===u.type){if("("===u.value){a++,a>n&&(n=a);continue}if(")"===u.value){a=Math.max(0,a-1);continue}"+"!==u.value&&"-"!==u.value&&"×"!==u.value&&"÷"!==u.value||t.push(u.value)}return{exprLen:e.length,maxDepth:n,ops:t}}function O(){try{const e=a.getCurrentUser&&a.getCurrentUser();if(!e||!e.id)return void(b.value=null);const t=a.readStatsExtended&&a.readStatsExtended(e.id),n=(t&&Array.isArray(t.rounds)?t.rounds.slice().reverse():[]).find((e=>e&&e.success&&Number.isFinite(e.timeMs)));b.value=n?n.timeMs:null}catch(e){b.value=null}}function G(e){if(!Number.isFinite(e))return"-";if(e<1e3)return e+"ms";const t=e/1e3;if(t<60)return t.toFixed(1)+"s";return`${Math.floor(t/60)}m${Math.round(t%60)}s`}function V(e){if(!Number.isFinite(e))return"-";const t=e/1e3;return t<120?t.toFixed(1)+"s":G(e)}function ee(){const e=r.value.reduce(((e,t)=>e+(t?1:0)),0);if(k.value="",4!==e)return o.value="请先用完四张牌再提交",void(g.value=!0);if(!function(){const e=i.value||[];if(!e.length)return!1;let t=0,a=null;const n=e=>"+"===e||"-"===e||"×"===e||"÷"===e;for(const l of e){if("op"===l.type&&"("===l.value)t++;else if("op"===l.type&&")"===l.value&&(t--,t<0))return!1;if(a){const e="op"===a.type?a.value:"num",t="op"===l.type?l.value:"num";if(n(e)&&n(t))return!1}else if("op"===l.type&&(")"===l.value||n(l.value)))return!1;a=l}const u=e[e.length-1];return(!u||"op"!==u.type||"("!==u.value&&!n(u.value))&&0===t}())return o.value="表达式错误",void(g.value=!0);const n=Q.value,l=t.evaluateExprToFraction(n),v=l&&l.equalsInt&&l.equalsInt(24);if(o.value=v?"恭喜，得到 24！":"计算错误",g.value=!v,v&&!s.value){s.value=!0,h.value+=1,p.value+=1;try{const e=Z();a.pushRound({success:!0,timeMs:Date.now()-(w.value||Date.now()),hintUsed:!!T.value,retries:Math.max(0,(M.value||1)-1),ops:e.ops,exprLen:e.exprLen,maxDepth:e.maxDepth,faceUseHigh:!!c.value,hand:{cards:(u.value||[]).map((e=>({rank:e.rank,suit:e.suit})))},expr:n}),O()}catch(d){}try{m.value=!0,setTimeout((()=>{m.value=!1,Y()}),500)}catch(d){Y()}}else if(!v){try{l&&"function"==typeof l.toString&&(k.value="结果："+l.toString())}catch(d){k.value=""}try{const e=Z();x.value+=1,a.pushRound({success:!1,timeMs:Date.now()-(w.value||Date.now()),hintUsed:!!T.value,retries:M.value||0,ops:e.ops,exprLen:e.exprLen,maxDepth:e.maxDepth,faceUseHigh:!!c.value,hand:{cards:(u.value||[]).map((e=>({rank:e.rank,suit:e.suit})))},expr:n})}catch(d){}try{y.value=!0,setTimeout((()=>{y.value=!1}),500)}catch(d){}}try{C()}catch(d){}}function te(){if(T.value=!0,!s.value){s.value=!0,h.value+=1,x.value+=1;try{const e=Z();a.pushRound({success:!1,timeMs:Date.now()-(w.value||Date.now()),hintUsed:!0,retries:M.value||0,ops:e.ops,exprLen:e.exprLen,maxDepth:e.maxDepth,faceUseHigh:!!c.value,hand:{cards:(u.value||[]).map((e=>({rank:e.rank,suit:e.suit})))},expr:Q.value}),O()}catch(e){}}o.value=l.value?"答案："+l.value:"暂无提示"}function ae(){c.value=!c.value}function ne(){if(!s.value){s.value=!0,h.value+=1,x.value+=1;try{const e=Z();a.pushRound({success:!1,timeMs:Date.now()-(w.value||Date.now()),hintUsed:!!T.value,retries:M.value||0,ops:e.ops,exprLen:e.exprLen,maxDepth:e.maxDepth,faceUseHigh:!!c.value,hand:{cards:(u.value||[]).map((e=>({rank:e.rank,suit:e.suit})))},expr:Q.value}),O()}catch(e){}}Y()}function ue(){X(),h.value=0,p.value=0,x.value=0,s.value=!1,o.value="",e.nextTick$1((()=>{Y(),C()}))}function le(){try{e.index.reLaunch({url:"/pages/login/index"})}catch(t){try{e.index.navigateTo({url:"/pages/login/index"})}catch(a){}}}function oe(e,t){L.value.active=!0,L.value.token=e;const a=fe(t);L.value.x=a.x,L.value.y=a.y,L.value.startX=a.x,L.value.startY=a.y,L.value.moved=!1,ve()}function re(e){if(!L.value.active)return;const t=fe(e);L.value.x=t.x,L.value.y=t.y;const a=L.value.x-L.value.startX,n=L.value.y-L.value.startY;!L.value.moved&&a*a+n*n>16&&(L.value.moved=!0);const u=L.value.token;if(u&&"tok"===u.type){const e=L.value.x,t=L.value.y;if(de(_.value,e,t)){const a=pe(e,t);a!==u.index&&a!==u.index+1&&(xe(u.index,a),u.index=a>u.index?a-1:a,ve()),j.value=a}else j.value=-1}else{const e=L.value.x,t=L.value.y,a=de(_.value,e,t);j.value=a?pe(e,t):-1}}function ie(){if(!L.value.active)return;const e=L.value.x,t=L.value.y,a=L.value.token,n=de(_.value,e,t);if(a&&!L.value.moved)return"tok"===a.type?se(a.index):"num"!==a.type&&"op"!==a.type||(!function(e){ce(e,i.value.length)}(a),B.value=Math.max(0,i.value.length-1),setTimeout((()=>{B.value=-1}),220)),L.value.active=!1,L.value.token=null,void(j.value=-1);if(a&&"tok"===a.type)if(n){const n=pe(e,t);xe(a.index,n),B.value=Math.max(0,Math.min(n,i.value.length-1)),setTimeout((()=>{B.value=-1}),220)}else se(a.index);else if(n&&a){const n=pe(e,t);ce(a,n),B.value=Math.max(0,Math.min(n,i.value.length-1)),setTimeout((()=>{B.value=-1}),220)}L.value.active=!1,L.value.token=null,j.value=-1}function ce(e,t){const a=Math.max(0,Math.min(t,i.value.length));if("num"===e.type){const t=e.cardIndex;if(null==t)return void(o.value="请选择一张牌");if((r.value[t]||0)>=1)return void(o.value="该牌已使用");const n=i.value.slice();n.splice(a,0,{type:"num",value:e.value,rank:e.rank,suit:e.suit,cardIndex:t}),i.value=n;const u=r.value.slice();u[t]=1,r.value=u}else if("op"===e.type){const t=i.value.slice();t.splice(a,0,{type:"op",value:e.value}),i.value=t}}function se(e){if(e<0||e>=i.value.length)return;const t=i.value[e];if(t&&"num"===t.type&&null!=t.cardIndex){const e=r.value.slice();e[t.cardIndex]=0,r.value=e}i.value=i.value.slice(0,e).concat(i.value.slice(e+1))}function ve(){e.index.createSelectorQuery().in(E).select("#exprZone").boundingClientRect().selectAll(".tok").boundingClientRect().exec((e=>{const[t,a]=e||[];t&&(_.value={left:t.left,top:t.top,right:t.right,bottom:t.bottom}),F.value=a||[]}))}function de(e,t,a){return t>=e.left&&t<=e.right&&a>=e.top&&a<=e.bottom}function fe(e){const t=e&&e.touches&&e.touches[0]||e&&e.changedTouches&&e.changedTouches[0]||e&&e.detail||{x:0,y:0};return{x:t.clientX??t.x??0,y:t.clientY??t.y??0}}function he(){K.value=1,e.nextTick$1((()=>{e.index.createSelectorQuery().in(E).select("#exprZone").boundingClientRect().select("#exprRow").boundingClientRect().exec((e=>{const[t,a]=e||[];if(!t||!a)return;const n=t.width-24,u=a.width||0;if(n>0&&u>0){const e=Math.min(1,n/u);K.value=isFinite(e)&&e>0?e:1}else K.value=1}))}))}function pe(e,t){const a=F.value||[];if(!a.length)return i.value.length;let n=0,u=1/0;for(let o=0;o<a.length;o++){const l=a[o],r=l.left+l.width/2-e,i=l.top+l.height/2-t,c=r*r+i*i;c<u&&(u=c,n=o)}const l=a[n];return e<l.left+l.width/2?n:n+1}function xe(e,t){if(e===t)return;const a=i.value.slice(),n=a.splice(e,1)[0],u=Math.max(0,Math.min(t,a.length));a.splice(u,0,n),i.value=a}function me(){try{const t=(e.index.getSystemInfoSync&&e.index.getSystemInfoSync()||{}).windowHeight||("undefined"!=typeof window?window.innerHeight:0)||0;t&&document.documentElement&&document.documentElement.style.setProperty("--vh",.01*t+"px")}catch(t){}}function ye(){const t=e.index.getSystemInfoSync&&e.index.getSystemInfoSync()||{},a=t.windowHeight||t.screenHeight||0;N.value=a&&a<640?"tight":a&&a<740?"compact":"normal",e.nextTick$1((()=>{e.index.createSelectorQuery().in(E).select("#exprZone").boundingClientRect().select("#hintText").boundingClientRect().select("#opsRow1").boundingClientRect().select("#opsRow2").boundingClientRect().select("#submitRow").boundingClientRect().select("#failRow").boundingClientRect().exec((e=>{const[t,a,n,u,l,o]=e||[];if(!t)return;a&&a.height,n&&n.height,u&&u.height,l&&l.height,o&&o.height;t.top,v.value=70}))}))}function ge(e){return 1===e?1:11===e||12===e||13===e?c.value?e:1:e}function ke(e){return 1===e?"A":11===e?"J":12===e?"Q":13===e?"K":String(e)}function we(e){return`/static/cards/${{S:"Spade",H:"Heart",D:"Diamond",C:"Club"}[e.suit]||"Spade"}${{1:"A",11:"J",12:"Q",13:"K"}[e.rank]||String(e.rank)}.png`}return e.computed((()=>{M.value+=1;const e=Q.value;if(!e)return"";const a=t.evaluateExprToFraction(e);return a?`${a.toString()}`:""})),e.onMounted((()=>{a.ensureInit();try{e.index.hideTabBar&&e.index.hideTabBar()}catch(t){}try{const l=a.getUsers&&a.getUsers();if(0==(l&&Array.isArray(l.list)?l.list:[]).length){try{e.index.showModal({title:"暂无用户",content:"请先新建用户后再开始程序。",confirmText:"去新建",showCancel:!1,success:()=>{try{e.index.reLaunch({url:"/pages/login/index"})}catch(a){try{e.index.navigateTo({url:"/pages/login/index"})}catch(t){}}}})}catch(t){try{e.index.reLaunch({url:"/pages/login/index"})}catch(n){try{e.index.navigateTo({url:"/pages/login/index"})}catch(u){}}}return}}catch(t){}d.value=a.getCurrentUser()||null;D()||(X(),Y()),setTimeout((()=>{J.value=!0}),0),e.nextTick$1((()=>{me(),ye(),he()})),e.index.onWindowResize&&e.index.onWindowResize((()=>{me(),he(),ye()})),O(),I()})),e.onShow((()=>{D(),I()})),e.onHide((()=>{C(),H()})),e.onUnmounted((()=>{H()})),e.watch(i,(()=>he())),(t,a)=>e.e({a:e.t(d.value&&d.value.name?d.value.name:"未选择"),b:e.o(le),c:e.t(R.value),d:e.t(h.value),e:e.t(p.value),f:e.t(x.value),g:e.t($.value),h:e.t(null!=b.value?G(b.value):"-"),i:U.value<12e4},U.value<12e4?{j:e.t(V(U.value))}:{k:e.o(ue)},{l:e.f(u.value,((t,a,n)=>({a:we(t),b:a,c:(r.value[a]||0)>0?1:"",d:e.o((e=>oe({type:"num",value:String(t.rank),rank:t.rank,suit:t.suit,cardIndex:a},e)),a),e:e.o((e=>re(e)),a),f:e.o((e=>ie()),a)}))),m:e.f(["+","-","×","÷"],((t,a,n)=>({a:e.t(t),b:t,c:e.o((e=>oe({type:"op",value:t},e)),t),d:e.o((e=>re(e)),t),e:e.o((e=>ie()),t)}))),n:e.n(z.value),o:e.f(["(",")"],((t,a,n)=>({a:e.t(t),b:t,c:e.o((e=>oe({type:"op",value:t},e)),t),d:e.o((e=>re(e)),t),e:e.o((e=>ie()),t)}))),p:e.t(c.value?"J/Q/K=11/12/13":"J/Q/K=1"),q:e.o(ae),r:e.n(z.value),s:L.value.active},L.value.active?{t:e.t(P.value),v:e.s(q.value)}:{},{w:e.f(i.value,((t,a,n)=>e.e({a:j.value===a},j.value===a?{b:e.n(W.value)}:{},{c:"num"===t.type},"num"===t.type?{d:we({rank:t.rank||+t.value,suit:t.suit||"S"})}:{e:e.t(t.value)},{f:e.n("num"===t.type?"num":"op"),g:e.n({"just-inserted":a===B.value,dragging:L.value.token&&"tok"===L.value.token.type&&L.value.token.index===a}),h:e.o((e=>oe({type:"tok",index:a,value:t.value},e)),a),i:e.o((e=>re(e)),a),j:e.o((e=>ie()),a),k:a}))),x:j.value===i.value.length},j.value===i.value.length?{y:e.n(W.value)}:{},{z:"scale("+K.value+")",A:L.value.active?1:"",B:v.value+"px",C:e.t(o.value||"请用四张牌和运算符算出 24"),D:g.value?1:"",E:e.o(ee),F:e.o(te),G:e.o(ne),H:m.value},(m.value,{}),{I:y.value},y.value?e.e({J:k.value},k.value?{K:e.t(k.value)}:{}):{},{L:J.value?1:""})}},l=e._export_sfc(u,[["__scopeId","data-v-6ede79c0"]]);wx.createPage(l);
