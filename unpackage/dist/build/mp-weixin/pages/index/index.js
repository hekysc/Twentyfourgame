"use strict";const e=require("../../common/vendor.js"),a=require("../../utils/solver.js"),t=require("../../utils/store.js"),u=require("../../utils/useSafeArea.js"),l=require("../../utils/tab-cache.js"),n=require("../../utils/calc.js"),r=require("../../core/basic-mode.js"),i=require("../../core/game-engine.js"),o=require("../../utils/mistakes.js"),s=require("../../utils/hints.js"),c=require("../../utils/edge-exit.js"),v=require("../../utils/prefs.js"),d=require("../../utils/avatar.js"),f=require("../../utils/navigation.js");Math||(p+h)();const h=()=>"../../components/CustomTabBar.js",p=()=>"../../components/PlayingCard.js",m={__name:"index",setup(h){const p=e.ref([{rank:1,suit:"S"},{rank:5,suit:"H"},{rank:5,suit:"D"},{rank:5,suit:"C"}]),m=e.ref(null),y=e.ref([0,0,0,0]),x=e.ref([]);let g="basic";try{const e=v.getLastMode();"pro"!==e&&"basic"!==e||(g=e)}catch(Fa){}const k=e.ref(g);try{v.setLastMode(g)}catch(Fa){}const b=e.computed((()=>"pro"===k.value?"Pro模式":"Basic模式")),w=e.ref([]),T=e.ref({first:null,operator:null}),S=e.ref([]),A=e.ref(""),M=e.ref(""),R=e.ref(!1),C=e.ref(!1),I=e.ref(200),D=e.ref(null),E=e.ref(!1),H=e.computed((()=>(D.value&&"string"==typeof D.value.name?D.value.name.trim():"")||"未登录")),U=e.computed((()=>D.value&&D.value.avatar?D.value.avatar:"")),$=e.computed((()=>function(e){if(!e)return"U";const a=String(e).trim();return a.length?a[0].toUpperCase():"U"}(H.value))),F=e.computed((()=>function(e){const a=String((null==e?void 0:e.id)||(null==e?void 0:e.name)||"");if(!a)return"#e2e8f0";let t=0;for(let l=0;l<a.length;l++)t=33*t+a.charCodeAt(l)>>>0;const u=["#e2e8f0","#fde68a","#bbf7d0","#bfdbfe","#fecaca","#f5d0fe","#c7d2fe"];return u[t%u.length]}(D.value))),L=e.ref([]),j=e.ref("normal"),q=e.computed((()=>"mistake"===j.value?"题库：错题":"题库：整副")),B=e.ref(new Set),P=e.ref(0),_=e.ref("normal"),N=e.ref(""),K=e.ref(0),O=e.ref(0),Q=e.ref(0);e.ref(!1);const z=e.ref({visible:!1,left:0,top:0}),J=e.computed((()=>({left:`${z.value.left}px`,top:`${z.value.top}px`}))),W=e.ref(!1),X=e.ref(!1),Y=e.ref(""),Z=e.ref(""),V=e.ref(Date.now()),G=e.ref(Date.now()),ee=e.ref(!1),ae=e.ref(0),te=e.ref(null),ue=e.ref(!1),le=e.ref(null),ne=e.ref(!1),{safeTop:re,safeBottom:ie,windowHeight:oe,refreshSafeArea:se}=u.useSafeArea(),ce=e.computed((()=>({paddingTop:`${Math.max(0,re.value||0)}px`}))),ve=e.ref(u.rpxToPx(520)),de=e.ref(u.rpxToPx(320)),fe=e.ref(0);let he=null;const{hintState:pe,showHint:me,hideHint:ye}=s.useFloatingHint(),xe={SAME_INDEX:"请选择另一张牌",INACTIVE_SLOT:"请选择有效的数字",DIVIDE_BY_ZERO:"除数不能为 0",INVALID_OPERATION:"无法进行该运算，请重试"};const ge=c.useEdgeExit({showHint:me,onExit:()=>function(){C.value||me("本局进度将丢失",1200);f.exitApp({fallback:()=>{try{if("function"==typeof e.index.switchTab)return void e.index.switchTab({url:"/pages/stats/index"})}catch(Fa){}try{if("function"==typeof e.index.reLaunch)return void e.index.reLaunch({url:"/pages/stats/index"})}catch(Fa){}}})}()}),ke=n.formatMs,be=n.formatMsShort;function we(){Te(),he||(he=setTimeout((()=>{he=null,function(){try{e.nextTick$1((()=>{var a,t;const l=e.index.createSelectorQuery();l&&qe&&l.in(qe),null==(a=null==l?void 0:l.select("#gameTopBox"))||a.boundingClientRect((e=>{e&&Number.isFinite(e.height)&&(ve.value=Math.max(e.height,u.rpxToPx(520)))})),null==(t=null==l?void 0:l.select("#gameBottomBox"))||t.boundingClientRect((e=>{e&&Number.isFinite(e.height)&&(de.value=Math.max(e.height,u.rpxToPx(320)))})),null==l||l.exec((()=>{Te()}))}))}catch(Fa){Te()}}()}),16))}function Te(){const e="undefined"!=typeof window&&Number.isFinite(window.innerHeight)?window.innerHeight:0,a=oe.value||e;if(!a)return void(fe.value=Math.max(0,fe.value||0));const t=Math.max(ve.value||0,u.rpxToPx(520)),n=Math.max(de.value||0,u.rpxToPx(320)),r=Math.max(0,re.value||0),i=Math.max(0,ie.value||0),o=l.getTabBarHeight(),s=a-r-t-n-(o&&o>0?o:u.rpxToPx(120)+i);fe.value=Math.max(0,s)}function Se(){E.value=!0}function Ae(){try{const a={deck:L.value||[],cards:p.value||[],tokens:(x.value||[]).map((e=>({type:e.type,value:e.value,rank:e.rank,suit:e.suit}))),usedByCard:y.value||[],faceUseHigh:!!R.value,handRecorded:!!C.value,handStartTs:V.value||0,hintWasUsed:!!ee.value,attemptCount:ae.value||0,handsPlayed:K.value||0,successCount:O.value||0,failCount:Q.value||0,handFailedOnce:!!ne.value,solution:m.value||null,deckSource:j.value||"normal",mistakeRunUsed:Array.from(B.value||[]),mistakeRunStamp:P.value||0,currentHandSource:_.value||"normal",currentMistakeKey:N.value||"",mode:k.value||"basic"};e.index.setStorageSync("tf24_game_session_v1",JSON.stringify(a))}catch(Fa){}}function Me(){try{const t=e.index.getStorageSync("tf24_game_session_v1");if(!t)return!1;const u="string"==typeof t?JSON.parse(t):t;if(!u||!Array.isArray(u.deck)||!Array.isArray(u.cards))return!1;if(4===(u.cards||[]).length){L.value=u.deck,p.value=u.cards,Ve(),x.value=Array.isArray(u.tokens)?u.tokens:[],y.value=Array.isArray(u.usedByCard)?u.usedByCard:[0,0,0,0],R.value=!!u.faceUseHigh,C.value=!!u.handRecorded,V.value=u.handStartTs||Date.now(),ee.value=!!u.hintWasUsed,ae.value=u.attemptCount||0,K.value=u.handsPlayed||0,O.value=u.successCount||0,Q.value=u.failCount||0,ne.value=!!u.handFailedOnce,m.value=u.solution||null,j.value="mistake"===u.deckSource?"mistake":"normal",B.value=new Set(Array.isArray(u.mistakeRunUsed)?u.mistakeRunUsed:[]),P.value=u.mistakeRunStamp||0,_.value="mistake"===u.currentHandSource?"mistake":"normal",N.value="string"==typeof u.currentMistakeKey?u.currentMistakeKey:"";const t="pro"===u.mode?"pro":"basic";k.value=t;try{v.setLastMode(t)}catch(Fa){}if(la(),!m.value)try{const e=(p.value||[]).map((e=>n.mapCardRank(e.rank,R.value)));m.value=4===e.length?a.solve24(e):null}catch(Fa){m.value=null}return e.nextTick$1((()=>{Ua(),Da(),$a()})),!0}return!1}catch(Fa){return!1}}const Re=e.computed((()=>{if("mistake"===j.value){const e=Pe.value;if(!e)return 0;const a=o.getActivePool(e)||[];if(!Array.isArray(a)||0===a.length)return 0;const t=B.value instanceof Set?B.value:new Set;let u=0;for(const l of a)l&&l.key&&(t.has(l.key)||(u+=1));return 4*u}return Array.isArray(L.value)?L.value.length:0})),Ce=e.computed((()=>{const e=O.value+Q.value;return e?Math.round(100*O.value/e):0})),Ie=e.computed((()=>{const e=V.value||Date.now(),a=(G.value||Date.now())-e;return a>0?a:0}));let De=null;function Ee(){if(!De)try{De=setInterval((()=>{G.value=Date.now()}),100)}catch(Fa){De=null}}function He(){if(De){try{clearInterval(De)}catch(Fa){}De=null}}const Ue=e.ref({active:!1,token:null,x:0,y:0,startX:0,startY:0,moved:!1}),$e=e.ref({left:0,top:0,right:0,bottom:0}),Fe=e.ref([]),Le=e.ref(-1),je=e.ref(-1),{proxy:qe}=e.getCurrentInstance(),Be=e.ref(!1),Pe=e.computed((()=>D.value&&D.value.id?D.value.id:"")),_e=e.computed((()=>(p.value||[]).map((e=>e.rank)).sort(((e,a)=>e-a))));e.watch([re,oe,ie],(()=>{we()})),e.watch(Pe,((a,t)=>{if(a===t)return;const u="mistake"===j.value;sa(u?Date.now():0),!a&&u?(j.value="normal",sa(0),e.nextTick$1((()=>{ia()}))):u&&a&&e.nextTick$1((()=>{ia()}))}));const Ne=e.computed((()=>n.tokensToExpression(x.value,R.value))),Ke=e.computed((()=>`left:${Ue.value.x}px; top:${Ue.value.y}px;`)),Oe=e.ref(1),Qe=e.ref("normal"),ze=e.computed((()=>"tight"===Qe.value?"ops-tight":"compact"===Qe.value?"ops-compact":"")),Je=e.computed((()=>{const e=Ue.value.token;return e?"num"===e.type?n.labelForRank(e.rank||+e.value):"tok"===e.type?/^(10|11|12|13|[1-9])$/.test(e.value)?n.labelForRank(+e.value):e.value:e.value||"":""})),We=e.computed((()=>{const e=Ue.value.token;return Ue.value.active&&e?"num"===e.type?"num":"op"===e.type?"op":"tok"===e.type&&/^(10|11|12|13|[1-9])$/.test(e.value)?"num":"op":"op"}));function Xe(){Y.value&&(Y.value="")}function Ye(){me("表达式不合法，请重试",1600)}function Ze(e){const a=w.value[e];return{hidden:!a||!a.alive,selected:T.value.first===e,result:!(!a||!a.alive||"value"!==a.source)}}function Ve(){const e=r.createBasicState(p.value||[],R.value);w.value=e.slots,T.value={first:null,operator:null},S.value=[],A.value=e.expression,M.value=e.displayExpression}function Ge(e){if("basic"!==k.value||ue.value)return;const a=w.value[e];if(!a||!a.alive)return;const t=T.value;if(t.operator&&null!==t.first)return t.first===e?void(T.value={first:null,operator:null}):void function(e,a,t){const u=r.combineBasicSlots({slots:w.value,history:S.value,expression:A.value,displayExpression:M.value},e,a,t);if(!u.ok)return T.value={first:null,operator:null},void(u.err&&(l=u.err,me(xe[l]||"操作无效，请重试",{interactive:!0})));var l;const n=u.data;w.value=n.slots,S.value=n.history,A.value=n.expression,M.value=n.displayExpression;let i=null;for(let r=0;r<n.slots.length;r++)if(n.slots[r]&&n.slots[r].alive&&"value"===n.slots[r].source){i=r;break}T.value={first:i,operator:null},Z.value="",1===n.aliveCount&&pa({ok:!!n.isSolved,expression:n.exprForRecord,valueFraction:n.result,stats:n.stats,origin:"basic",allowRetry:!n.isSolved});try{Ae()}catch(Fa){}}(t.first,e,t.operator);t.first!==e?T.value={first:e,operator:null}:T.value={first:null,operator:null}}function ea(){const e=r.undoBasicHistory(S.value);if(!e.ok)return;const a=e.data;S.value=a.history,w.value=a.slots,A.value=a.expression,M.value=a.displayExpression,T.value={first:null,operator:null},Z.value="";try{Ae()}catch(Fa){}}function aa(){Ve(),Z.value="";try{Ae()}catch(Fa){}}function ta(){k.value="pro"===k.value?"basic":"pro"}function ua(){L.value=i.newDeck()}function la(){z.value={visible:!1,left:0,top:0}}function na(){z.value.visible?la():function(){try{e.index.createSelectorQuery().in(qe).select("#timerCell").boundingClientRect().exec((a=>{const[t]=a||[];if(!t)return void(z.value={visible:!0,left:0,top:0});const u=e.index.getSystemInfoSync&&e.index.getSystemInfoSync()||{};let l=(t.bottom||(t.top||0)+(t.height||0))+8;const n=u&&Number.isFinite(u.windowHeight)?u.windowHeight-96:0;n&&l>n&&(l=n);const r=t.left+t.width/2;z.value={visible:!0,left:r,top:l}}))}catch(Fa){z.value={visible:!0,left:0,top:0}}}()}function ra(){la(),Z.value="",Y.value="",ia()}async function ia(){la();const t=await async function(){if("mistake"===j.value)return await async function(){const t=Pe.value;if(!t){me("请先选择用户",1600),j.value="normal";try{Ae()}catch(Fa){}return await oa()}const u=o.getActivePool(t)||[];if(!Array.isArray(u)||0===u.length)return await new Promise((a=>{const t=()=>{da("normal"),a(null)};try{e.index.showModal({title:"提示",content:"无错题，切换到整副牌。",confirmText:"OK",showCancel:!1,success:()=>t(),fail:()=>t()})}catch(Fa){t()}})),null;const l=B.value instanceof Set?B.value:new Set,r=u.filter((e=>e&&e.key&&!l.has(e.key)));if(!r.length)return await new Promise((a=>{const t=()=>{ca(),a(null)};try{e.index.showActionSheet({title:"本轮错题已出完",itemList:["重新出题","切换整副","去统计"],success:t=>{const u="number"==typeof(null==t?void 0:t.tapIndex)?t.tapIndex:-1;0===u?ca():1===u?da("normal"):2===u?function(){try{e.index.reLaunch({url:"/pages/stats/index"})}catch(a){try{e.index.navigateTo({url:"/pages/stats/index"})}catch(Fa){}}}():ca(),a(null)},fail:()=>t()})}catch(Fa){t()}})),null;const i=r[Math.floor(Math.random()*r.length)],s=function(e){const a=["S","H","D","C"];return(Array.isArray(e)?e:[]).map(((e,t)=>({rank:Number.isFinite(+e)?Math.min(13,Math.max(1,Math.floor(+e))):1,suit:a[t%a.length]})))}(Array.isArray(null==i?void 0:i.nums)?i.nums:[]);let c=null;try{const e=s.map((e=>n.mapCardRank(e.rank,R.value)));c=4===e.length?a.solve24(e):null}catch(Fa){c=null}const v=new Set(l);v.add(i.key),B.value=v;try{Ae()}catch(Fa){}return{source:"mistake",cards:s,deck:L.value,solution:c,mistakeKey:i.key}}();return await oa()}();if(t){ue.value=!1,le.value=null,ne.value=!1,C.value=!1,ae.value=0,ee.value=!1,Z.value="",Y.value="",Array.isArray(t.deck)&&(L.value=t.deck),p.value=Array.isArray(t.cards)?t.cards:[],_.value="mistake"===t.source?"mistake":"normal",N.value="mistake"===t.source&&t.mistakeKey||"",m.value=t.solution||null,x.value=[],y.value=[0,0,0,0],C.value=!1,V.value=Date.now(),ee.value=!1,ae.value=0,e.nextTick$1((()=>$a()));try{Ae()}catch(Fa){}}}async function oa(){if((!Array.isArray(L.value)||L.value.length<4)&&ua(),!Array.isArray(L.value)||L.value.length<4)return fa(),null;const e=i.drawSolvableHand(L.value,R.value,a.solve24);return e.ok?{source:"normal",cards:e.data.cards,deck:e.data.deck,solution:e.data.solution}:(fa(),null)}function sa(e=0){B.value=new Set,P.value=e,N.value=""}function ca(){sa(Date.now());try{Ae()}catch(Fa){}e.nextTick$1((()=>{"mistake"===j.value&&ia()}))}function va(){da("mistake"===j.value?"normal":"mistake")}function da(a){const t="mistake"===a?"mistake":"normal";if(j.value!==t)if("mistake"!==t){j.value="normal",(!Array.isArray(L.value)||L.value.length<4)&&ua();try{Ae()}catch(Fa){}e.nextTick$1((()=>{ia()}))}else{if(!Pe.value)return void me("请先选择用户",1600);j.value="mistake";try{Ae()}catch(Fa){}e.nextTick$1((()=>{ia()}))}}function fa(){try{e.index.showModal({title:"牌库用尽",content:"余牌无解或整副用完，是否重新洗牌？",confirmText:"重洗",cancelText:"进入统计",success:a=>{if(a.confirm)ua(),K.value=0,O.value=0,Q.value=0,e.nextTick$1((()=>ia()));else try{e.index.reLaunch({url:"/pages/stats/index"})}catch(t){try{e.index.navigateTo({url:"/pages/stats/index"})}catch(Fa){}}}})}catch(Fa){ua(),K.value=0,O.value=0,Q.value=0,e.nextTick$1((()=>ia()))}}function ha(){try{const e=t.getCurrentUser&&t.getCurrentUser();if(!e||!e.id)return void(te.value=null);const a=t.readStatsExtended&&t.readStatsExtended(e.id);if(a&&(null==e?void 0:e.id))try{l.mergeCachedStatsExt({[e.id]:a})}catch(Fa){}const u=(a&&Array.isArray(a.rounds)?a.rounds.slice().reverse():[]).find((e=>e&&e.success&&Number.isFinite(e.timeMs)));te.value=u?u.timeMs:null}catch(Fa){te.value=null}}function pa({ok:e,expression:u,valueFraction:r,stats:i,origin:s,allowRetry:c=!1}){const v=u||"",d=i||n.statsFromExpressionString(v),f=r||(v?a.evaluateExprToFraction(v):null),h=Date.now()-(V.value||Date.now()),m="pro"===s?Math.max(0,(ae.value||1)-1):0,y="pro"===s&&ae.value||0,x=c&&!e,g=e=>{if(Pe.value)try{o.recordRoundResult({userId:Pe.value,nums:_e.value,success:e})}catch(Fa){}try{t.pushRound({success:e,timeMs:h,hintUsed:!!ee.value,retries:e?m:y,ops:d.ops,exprLen:d.exprLen,maxDepth:d.maxDepth,faceUseHigh:!!R.value,hand:{cards:(p.value||[]).map((e=>({rank:e.rank,suit:e.suit})))},expr:v});try{l.scheduleTabWarmup({delay:200})}catch(Fa){}e&&ha()}catch(Fa){}};if(e){if(Z.value="","basic"===s&&ne.value){try{W.value=!0,setTimeout((()=>{W.value=!1}),500)}catch(Fa){}try{Ae()}catch(Fa){}return}if(ue.value){if("success"===le.value){try{Ae()}catch(Fa){}return}try{W.value=!0,setTimeout((()=>{W.value=!1,ia()}),500)}catch(Fa){ia()}try{Ae()}catch(Fa){}return}ue.value=!0,le.value="success",C.value=!0,K.value+=1,O.value+=1,g(!0);try{W.value=!0,setTimeout((()=>{W.value=!1,ia()}),500)}catch(Fa){ia()}try{Ae()}catch(Fa){}return}const k=()=>{try{f&&"function"==typeof f.toString?Z.value="结果："+f.toString():Z.value=""}catch(Fa){Z.value=""}};if(x){k(),ne.value||(ne.value=!0,le.value="fail",C.value=!0,K.value+=1,Q.value+=1,g(!1));try{X.value=!0,setTimeout((()=>{X.value=!1}),500)}catch(Fa){}try{Ae()}catch(Fa){}}else{k(),ue.value||(ue.value=!0,le.value="fail",C.value=!0,K.value+=1,Q.value+=1,g(!1));try{X.value=!0,setTimeout((()=>{X.value=!1}),500)}catch(Fa){}try{Ae()}catch(Fa){}}}function ma(){const e=y.value.reduce(((e,a)=>e+(a?1:0)),0);if(Z.value="",4!==e||!n.isExpressionComplete(x.value))return void Ye();const t=Ne.value;if(!t)return void Ye();ae.value+=1;const u=a.evaluateExprToFraction(t);pa({ok:u&&u.equalsInt&&u.equalsInt(24),expression:t,valueFraction:u,stats:n.computeExprStats(x.value),origin:"pro"})}function ya(){if(ee.value=!0,!m.value)try{const e=(p.value||[]).map((e=>n.mapCardRank(e.rank,R.value)));m.value=4===e.length?a.solve24(e):null}catch(Fa){m.value=null}if(!C.value){C.value=!0,K.value+=1,Q.value+=1;try{const e=n.computeExprStats(x.value);t.pushRound({success:!1,timeMs:Date.now()-(V.value||Date.now()),hintUsed:!0,retries:ae.value||0,ops:e.ops,exprLen:e.exprLen,maxDepth:e.maxDepth,faceUseHigh:!!R.value,hand:{cards:(p.value||[]).map((e=>({rank:e.rank,suit:e.suit})))},expr:Ne.value}),ha()}catch(Fa){}if(Pe.value)try{o.recordRoundResult({userId:Pe.value,nums:_e.value,success:!1})}catch(Fa){}}if("basic"===k.value){ne.value=!0;const e=m.value?"答案："+m.value:"暂无提示";M.value=e,me(e,2e3)}else Y.value=m.value?"答案："+m.value:"暂无提示";try{Ae()}catch(Fa){}}function xa(){R.value=!R.value}function ga(){if(!C.value){C.value=!0,K.value+=1,Q.value+=1;try{const e=n.computeExprStats(x.value);t.pushRound({success:!1,timeMs:Date.now()-(V.value||Date.now()),hintUsed:!!ee.value,retries:ae.value||0,ops:e.ops,exprLen:e.exprLen,maxDepth:e.maxDepth,faceUseHigh:!!R.value,hand:{cards:(p.value||[]).map((e=>({rank:e.rank,suit:e.suit})))},expr:Ne.value}),ha()}catch(Fa){}if(Pe.value)try{o.recordRoundResult({userId:Pe.value,nums:_e.value,success:!1})}catch(Fa){}}ia()}function ka(){ua(),K.value=0,O.value=0,Q.value=0,C.value=!1,e.nextTick$1((()=>{ia(),Ae()}))}function ba(){try{e.index.navigateTo({url:"/pages/login/index"})}catch(a){try{e.index.reLaunch({url:"/pages/login/index"})}catch(Fa){}}}function wa(e,a){Ue.value.active=!0,Ue.value.token=e;const t=Ia(a);Ue.value.x=t.x,Ue.value.y=t.y,Ue.value.startX=t.x,Ue.value.startY=t.y,Ue.value.moved=!1,Ra()}function Ta(e){if(!Ue.value.active)return;const a=Ia(e);Ue.value.x=a.x,Ue.value.y=a.y;const t=Ue.value.x-Ue.value.startX,u=Ue.value.y-Ue.value.startY;!Ue.value.moved&&t*t+u*u>16&&(Ue.value.moved=!0);const l=Ue.value.token;if(l&&"tok"===l.type){const e=Ue.value.x,a=Ue.value.y;if(Ca($e.value,e,a)){const t=Ea(e,a);t!==l.index&&t!==l.index+1&&(Ha(l.index,t),l.index=t>l.index?t-1:t,Ra()),Le.value=t}else Le.value=-1}else{const e=Ue.value.x,a=Ue.value.y,t=Ca($e.value,e,a);Le.value=t?Ea(e,a):-1}}function Sa(){if(!Ue.value.active)return;const e=Ue.value.x,a=Ue.value.y,t=Ue.value.token,u=Ca($e.value,e,a);if(t&&!Ue.value.moved)return"tok"===t.type?Ma(t.index):"num"!==t.type&&"op"!==t.type||(!function(e){Aa(e,x.value.length)}(t),je.value=Math.max(0,x.value.length-1),setTimeout((()=>{je.value=-1}),220)),Ue.value.active=!1,Ue.value.token=null,void(Le.value=-1);if(t&&"tok"===t.type)if(u){const u=Ea(e,a);Ha(t.index,u),je.value=Math.max(0,Math.min(u,x.value.length-1)),setTimeout((()=>{je.value=-1}),220)}else Ma(t.index);else if(u&&t){const u=Ea(e,a);Aa(t,u),je.value=Math.max(0,Math.min(u,x.value.length-1)),setTimeout((()=>{je.value=-1}),220)}Ue.value.active=!1,Ue.value.token=null,Le.value=-1}function Aa(e,a){Xe();const t=Math.max(0,Math.min(a,x.value.length));if("num"===e.type){const a=e.cardIndex;if(null==a)return;if((y.value[a]||0)>=1)return;const u=x.value.slice();u.splice(t,0,{type:"num",value:e.value,rank:e.rank,suit:e.suit,cardIndex:a}),x.value=u;const l=y.value.slice();l[a]=1,y.value=l}else if("op"===e.type){const a=x.value.slice();a.splice(t,0,{type:"op",value:e.value}),x.value=a}}function Ma(e){if(Xe(),e<0||e>=x.value.length)return;const a=x.value[e];if(a&&"num"===a.type&&null!=a.cardIndex){const e=y.value.slice();e[a.cardIndex]=0,y.value=e}x.value=x.value.slice(0,e).concat(x.value.slice(e+1))}function Ra(){e.index.createSelectorQuery().in(qe).select("#exprZone").boundingClientRect().selectAll(".tok").boundingClientRect().exec((e=>{const[a,t]=e||[];a&&($e.value={left:a.left,top:a.top,right:a.right,bottom:a.bottom}),Fe.value=t||[]}))}function Ca(e,a,t){return a>=e.left&&a<=e.right&&t>=e.top&&t<=e.bottom}function Ia(e){const a=e&&e.touches&&e.touches[0]||e&&e.changedTouches&&e.changedTouches[0]||e&&e.detail||{x:0,y:0};return{x:a.clientX??a.x??0,y:a.clientY??a.y??0}}function Da(){Oe.value=1,e.nextTick$1((()=>{e.index.createSelectorQuery().in(qe).select("#exprZone").boundingClientRect().select("#exprRow").boundingClientRect().exec((e=>{const[a,t]=e||[];if(!a||!t)return;const u=a.width-24,l=t.width||0;if(u>0&&l>0){const e=Math.min(1,u/l);Oe.value=isFinite(e)&&e>0?e:1}else Oe.value=1}))}))}function Ea(e,a){const t=Fe.value||[];if(!t.length)return x.value.length;let u=0,l=1/0;for(let r=0;r<t.length;r++){const n=t[r],i=n.left+n.width/2-e,o=n.top+n.height/2-a,s=i*i+o*o;s<l&&(l=s,u=r)}const n=t[u];return e<n.left+n.width/2?u:u+1}function Ha(e,a){if(Xe(),e===a)return;const t=x.value.slice(),u=t.splice(e,1)[0],l=Math.max(0,Math.min(a,t.length));t.splice(l,0,u),x.value=t}function Ua(){try{(e.index.getSystemInfoSync&&e.index.getSystemInfoSync()||{}).windowHeight||"undefined"!=typeof window&&window.innerHeight}catch(a){}}function $a(){if("pro"!==k.value)return void(I.value=70);const a=e.index.getSystemInfoSync&&e.index.getSystemInfoSync()||{},t=a.windowHeight||a.screenHeight||0;Qe.value=t&&t<640?"tight":t&&t<740?"compact":"normal",e.nextTick$1((()=>{e.index.createSelectorQuery().in(qe).select("#exprZone").boundingClientRect().select("#opsRow1").boundingClientRect().select("#opsRow2").boundingClientRect().select("#submitRow").boundingClientRect().select("#failRow").boundingClientRect().exec((e=>{const[a,u,l,n,r]=e||[];if(!a)return;const i=u&&u.height||0,o=l&&l.height||0,s=n&&n.height||0,c=r&&r.height||0;let v=t-(a.top||0)-(i+o+s+c)-12;(!isFinite(v)||v<=0)&&(v=120),I.value=Math.max(120,Math.floor(v))}))}))}return e.onMounted((()=>{t.ensureInit();try{e.index.hideTabBar&&e.index.hideTabBar()}catch(Fa){}try{const l=t.getUsers&&t.getUsers();if(0==(l&&Array.isArray(l.list)?l.list:[]).length){try{e.index.showModal({title:"暂无用户",content:"请先新建用户后再开始程序。",confirmText:"去新建",showCancel:!1,success:()=>{try{e.index.reLaunch({url:"/pages/login/index"})}catch(a){try{e.index.navigateTo({url:"/pages/login/index"})}catch(Fa){}}}})}catch(Fa){try{e.index.reLaunch({url:"/pages/login/index"})}catch(a){try{e.index.navigateTo({url:"/pages/login/index"})}catch(u){}}}return}}catch(Fa){}D.value=t.getCurrentUser()||null;Me()||(ua(),ia()),setTimeout((()=>{Be.value=!0}),0),e.nextTick$1((()=>{Ua(),$a(),Da()})),e.index.onWindowResize&&e.index.onWindowResize((()=>{Ua(),Da(),$a()})),ha(),Ee(),we(),d.consumeAvatarRestoreNotice()&&me("头像文件丢失，已为你恢复为默认头像",2e3)})),e.onShow((()=>{D.value=t.getCurrentUser()||null,Me(),Ee();try{se()}catch(Fa){}we();try{l.scheduleTabWarmup({delay:180})}catch(Fa){}try{e.index.$emit&&e.index.$emit("tabbar:update")}catch(Fa){}d.consumeAvatarRestoreNotice()&&me("头像文件丢失，已为你恢复为默认头像",2e3)})),e.onHide((()=>{Ae(),He(),la()})),e.onUnmounted((()=>{if(He(),he){try{clearTimeout(he)}catch(Fa){}he=null}})),e.watch(D,(()=>{E.value=!1})),e.watch(k,(a=>{const t="pro"===a?"pro":"basic";try{v.setLastMode(t)}catch(Fa){}"basic"===t?(I.value=70,Ve(),T.value={first:null,operator:null}):(x.value=[],y.value=[0,0,0,0],Y.value="",Z.value="",e.nextTick$1((()=>{Da(),$a()}))),la(),we()})),e.watch(p,(()=>{Ve()})),e.watch(R,(()=>{Ve()})),e.watch(x,(()=>Da())),(a,t)=>e.e({a:U.value&&!E.value},U.value&&!E.value?{b:U.value,c:e.o(Se)}:{d:e.t($.value),e:F.value},{f:e.t(H.value),g:e.o(ba),h:e.t(b.value),i:e.n("pro"===k.value?"mode-toggle-pro":"mode-toggle-basic"),j:e.o(ta),k:e.t(q.value),l:e.o(va),m:e.t(Re.value),n:e.t(K.value),o:e.t(O.value),p:e.t(Q.value),q:e.t(Ce.value),r:e.t(null!=te.value?e.unref(ke)(te.value):"-"),s:Ie.value<12e4},Ie.value<12e4?{t:e.t(e.unref(be)(Ie.value))}:{v:e.o(ka)},{w:e.o(na),x:e.f(p.value,((a,t,u)=>({a:"a09269df-0-"+u,b:e.p({card:a}),c:t,d:(y.value[t]||0)>0?1:"",e:e.o((e=>wa({type:"num",value:String(a.rank),rank:a.rank,suit:a.suit,cardIndex:t},e)),t),f:e.o((e=>Ta(e)),t),g:e.o((e=>Sa()),t)}))),y:e.f(["+","-","×","÷"],((a,t,u)=>({a:e.t(a),b:a,c:e.o((e=>wa({type:"op",value:a},e)),a),d:e.o((e=>Ta(e)),a),e:e.o((e=>Sa()),a)}))),z:e.n(ze.value),A:e.f(["(",")"],((a,t,u)=>({a:e.t(a),b:a,c:e.o((e=>wa({type:"op",value:a},e)),a),d:e.o((e=>Ta(e)),a),e:e.o((e=>Sa()),a)}))),B:e.t(R.value?"J/Q/K=11/12/13":"J/Q/K=1"),C:e.o(xa),D:e.n(ze.value),E:Ue.value.active},Ue.value.active?{F:e.t(Je.value),G:e.s(Ke.value)}:{},{H:Y.value},Y.value?{I:e.t(Y.value)}:{},{J:e.f(x.value,((a,t,u)=>e.e({a:Le.value===t},Le.value===t?{b:e.n(We.value)}:{},{c:"num"===a.type},"num"===a.type?{d:"a09269df-1-"+u,e:e.p({card:{rank:null!=a.rank?a.rank:Number(a.value),suit:a.suit||"S",value:a.value},size:"sm",fill:!0})}:{f:e.t(a.value)},{g:e.n("num"===a.type?"num":"op"),h:e.n({"just-inserted":t===je.value,dragging:Ue.value.token&&"tok"===Ue.value.token.type&&Ue.value.token.index===t}),i:e.o((e=>wa({type:"tok",index:t,value:a.value},e)),t),j:e.o((e=>Ta(e)),t),k:e.o((e=>Sa()),t),l:t}))),K:Le.value===x.value.length},Le.value===x.value.length?{L:e.n(We.value)}:{},{M:"scale("+Oe.value+")",N:Ue.value.active?1:"",O:0!==x.value.length||Y.value?"":1,P:I.value+"px",Q:"pro"===k.value,R:e.f([0,2],((a,t,u)=>e.e({a:w.value[a]&&w.value[a].alive&&"card"===w.value[a].source},w.value[a]&&w.value[a].alive&&"card"===w.value[a].source?{b:"a09269df-2-"+u,c:e.p({card:w.value[a].card,size:"md"})}:w.value[a]&&w.value[a].alive?{e:e.t(w.value[a].label)}:{},{d:w.value[a]&&w.value[a].alive,f:e.n(Ze(a)),g:e.o((e=>Ge(a)),"basic-left-"+a),h:"basic-left-"+a}))),S:e.f(["+","-","×","÷"],((a,t,u)=>({a:e.t(a),b:"basic-op-"+a,c:T.value.operator===a?1:"",d:e.o((e=>function(e){"basic"!==k.value||ue.value||(null!==T.value.first?T.value.operator!==e?T.value.operator=e:T.value.operator=null:me("请先选择一个数字",{interactive:!0}))}(a)),"basic-op-"+a)}))),T:e.t(R.value?"J/Q/K=11/12/13":"J/Q/K=1"),U:e.o(xa),V:e.f([1,3],((a,t,u)=>e.e({a:w.value[a]&&w.value[a].alive&&"card"===w.value[a].source},w.value[a]&&w.value[a].alive&&"card"===w.value[a].source?{b:"a09269df-3-"+u,c:e.p({card:w.value[a].card,size:"md"})}:w.value[a]&&w.value[a].alive?{e:e.t(w.value[a].label)}:{},{d:w.value[a]&&w.value[a].alive,f:e.n(Ze(a)),g:e.o((e=>Ge(a)),"basic-right-"+a),h:"basic-right-"+a}))),W:"pro"!==k.value,X:fe.value+"px",Y:"pro"===k.value,Z:e.o(ma),aa:!S.value.length,ab:e.o(ea),ac:e.o(aa),ad:"pro"!==k.value,ae:e.o(ya),af:e.o(ga),ag:"pro"===k.value,ah:e.o(ya),ai:e.o(ga),aj:"pro"!==k.value,ak:W.value},(W.value,{}),{al:X.value},X.value?e.e({am:Z.value},Z.value?{an:e.t(Z.value)}:{}):{},{ao:z.value.visible},z.value.visible?{ap:e.o(ra),aq:e.s(J.value),ar:e.o((()=>{})),as:e.o(la)}:{},{at:e.unref(pe).visible},e.unref(pe).visible?{av:e.t(e.unref(pe).text),aw:e.o((()=>{})),ax:e.unref(pe).interactive?1:"",ay:e.o(((...a)=>e.unref(ye)&&e.unref(ye)(...a)))}:{},{az:Be.value?1:"",aA:e.s(ce.value),aB:e.o(((...a)=>e.unref(ge).handleTouchStart&&e.unref(ge).handleTouchStart(...a))),aC:e.o(((...a)=>e.unref(ge).handleTouchMove&&e.unref(ge).handleTouchMove(...a))),aD:e.o(((...a)=>e.unref(ge).handleTouchEnd&&e.unref(ge).handleTouchEnd(...a))),aE:e.o(((...a)=>e.unref(ge).handleTouchCancel&&e.unref(ge).handleTouchCancel(...a)))})}},y=e._export_sfc(m,[["__scopeId","data-v-a09269df"]]);wx.createPage(y);
