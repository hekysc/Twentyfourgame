"use strict";const t=require("../common/vendor.js"),e=require("./prefs.js"),s="tf24_users_v1",a="tf24_stats_v1";function r(e,s){try{const a=t.index.getStorageSync(e);return a?"string"==typeof a?JSON.parse(a):a:s}catch(a){return s}}function n(e,s){try{t.index.setStorageSync(e,JSON.stringify(s))}catch(a){}}function o(){const t=r(s,null);if(t&&"object"==typeof t&&Array.isArray(t.list)){const e={...t};e.list=(t.list||[]).map((t=>({id:t.id||c(),name:t.name||"玩家",avatar:t.avatar||"",avatarUpdatedAt:Number.isFinite(t.avatarUpdatedAt)?t.avatarUpdatedAt:0,color:t.color||d(),createdAt:t.createdAt||Date.now(),lastPlayedAt:t.lastPlayedAt||0})));const a=new Set(e.list.filter((t=>"Guest"===String(t.name||""))).map((t=>t.id)));a.size>0&&(e.list=e.list.filter((t=>!a.has(t.id))),a.has(e.currentId)&&(e.currentId=e.list[0]&&e.list[0].id||"")),e!==t&&n(s,e)}else n(s,{list:[],currentId:""});const e=r(a,null);if(e&&"object"==typeof e){if(!e._version||e._version<2){const t={...e};for(const e of Object.keys(t)){if(e.startsWith&&e.startsWith("_"))continue;const s=t[e];if(!s||"object"!=typeof s){t[e]={totals:{total:0,success:0,fail:0},days:{},rounds:[],agg:{}};continue}const a=s.totals&&"object"==typeof s.totals?s.totals:{total:0,success:0,fail:0},r=s.days&&"object"==typeof s.days?s.days:{},n=Array.isArray(s.rounds)?s.rounds:[],o=s.agg&&"object"==typeof s.agg?s.agg:{};t[e]={totals:a,days:r,rounds:n,agg:o}}t._version=2,n(a,t)}}else n(a,{_version:2})}function i(){return r(s,{list:[],currentId:""})}function l(t){n(s,t)}function c(){return Math.random().toString(36).slice(2,10)}function d(){const t=["#e2e8f0","#fde68a","#bbf7d0","#bfdbfe","#fecaca","#f5d0fe","#c7d2fe"];return t[Math.floor(Math.random()*t.length)]}exports.addUser=function(t,e="",s){var a;const r=i(),n=c(),o={id:n,name:t||`玩家${((null==(a=r.list)?void 0:a.length)||0)+1}`,avatar:e||"",avatarUpdatedAt:0,color:s||d(),createdAt:Date.now(),lastPlayedAt:0};return r.list=(r.list||[]).concat([o]),r.currentId||(r.currentId=n),l(r),n},exports.allUsersWithStats=function(){const t=i().list||[],e=r(a,{});return t.map((t=>{const s=e[t.id]||{totals:{total:0,success:0,fail:0},days:{}},a=s.totals||{total:0,success:0,fail:0},r=a.total?Math.round(a.success/a.total*100):0,n=s.agg&&s.agg.bestTimeMs||void 0,o=s.agg&&s.agg.currentStreak||0,i=s.agg&&s.agg.longestStreak||0;return{id:t.id,name:t.name,totals:a,winRate:r,bestTimeMs:n,currentStreak:o,longestStreak:i}}))},exports.ensureInit=o,exports.getCurrentUser=function(){const t=i();return t.list.find((e=>e.id===t.currentId))},exports.getUsers=i,exports.pushRound=function(t){var e,s,o;const d=i().currentId;if(!d)return;const u=r(a,{_version:2});u._version||(u._version=2),u[d]||(u[d]={totals:{total:0,success:0,fail:0},days:{},rounds:[],agg:{}});const f=u[d],g=(new Date).toISOString().slice(0,10);f.days[g]||(f.days[g]={total:0,success:0,fail:0});const v="boolean"==typeof t,p=v?!!t:!!(null==t?void 0:t.success),h=Date.now(),y=v?null:{id:c(),ts:h,success:!!(null==t?void 0:t.success),timeMs:Number.isFinite(null==t?void 0:t.timeMs)?Math.max(0,Math.floor(t.timeMs)):void 0,hintUsed:!!(null==t?void 0:t.hintUsed),retries:Number.isFinite(null==t?void 0:t.retries)?Math.max(0,Math.floor(t.retries)):void 0,ops:Array.isArray(null==t?void 0:t.ops)?t.ops.slice(0,16):void 0,exprLen:Number.isFinite(null==t?void 0:t.exprLen)?Math.max(0,Math.floor(t.exprLen)):void 0,maxDepth:Number.isFinite(null==t?void 0:t.maxDepth)?Math.max(0,Math.floor(t.maxDepth)):void 0,faceUseHigh:"boolean"==typeof(null==t?void 0:t.faceUseHigh)?t.faceUseHigh:void 0,hand:(null==t?void 0:t.hand)&&Array.isArray(t.hand.cards)?{cards:t.hand.cards.map((t=>({rank:+t.rank,suit:t.suit})))}:void 0,solutionsCount:Number.isFinite(null==t?void 0:t.solutionsCount)?Math.max(0,Math.floor(t.solutionsCount)):void 0,expr:"string"==typeof(null==t?void 0:t.expr)?t.expr:void 0};if(f.totals.total+=1,f.days[g].total+=1,p?(f.totals.success+=1,f.days[g].success+=1):(f.totals.fail+=1,f.days[g].fail+=1),y){if(f.rounds.push(y),f.rounds.length>1e3&&f.rounds.splice(0,f.rounds.length-1e3),y.success&&Number.isFinite(y.timeMs)){const t=null==(e=f.agg)?void 0:e.bestTimeMs;f.agg.bestTimeMs=Number.isFinite(t)?Math.min(t,y.timeMs):y.timeMs}const t=(null==(s=f.agg)?void 0:s.currentStreak)||0;f.agg.currentStreak=p?t+1:0;const a=(null==(o=f.agg)?void 0:o.longestStreak)||0;f.agg.currentStreak>a&&(f.agg.longestStreak=f.agg.currentStreak)}n(a,u);try{const t=i(),e=(t.list||[]).find((t=>t.id===d));e&&(e.lastPlayedAt=Date.now(),l(t))}catch(m){}},exports.readStatsExtended=function(t){const e=r(a,{_version:2})[t]||{totals:{total:0,success:0,fail:0},days:{},rounds:[],agg:{}};return e.rounds||(e.rounds=[]),e.agg||(e.agg={}),e},exports.removeUser=function(t){const e=i();e.list=e.list.filter((e=>e.id!==t)),e.currentId===t&&(e.currentId=e.list[0]&&e.list[0].id||""),l(e)},exports.renameUser=function(t,e){const s=i(),a=s.list.find((e=>e.id===t));a&&(a.name=e,l(s))},exports.resetAllData=function(){try{t.index.clearStorageSync()}catch(e){}o()},exports.setUserAvatar=function(t,s,a){const r=i(),n=(r.list||[]).find((e=>e.id===t));if(!n)return;const o=s||"";if(n.avatar=o,o){const s=Number.isFinite(a)?Math.max(0,Math.floor(a)):Date.now();n.avatarUpdatedAt=s,e.writeAvatarMeta(t,{uri:o,lastModified:s})}else n.avatarUpdatedAt=0,e.clearAvatarMeta(t);l(r)},exports.setUsers=l,exports.switchUser=function(t){const e=i();e.list.find((e=>e.id===t))&&(e.currentId=t,l(e))},exports.touchLastPlayed=function(t){try{const e=i(),s=t||e.currentId;if(!s)return;const a=(e.list||[]).find((t=>t.id===s));a&&(a.lastPlayedAt=Date.now(),l(e))}catch(e){}};
