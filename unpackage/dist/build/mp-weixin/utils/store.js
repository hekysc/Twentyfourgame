"use strict";const t=require("../common/vendor.js"),s="tf24_users_v1",e="tf24_stats_v1";function n(s,e){try{const n=t.index.getStorageSync(s);return n?"string"==typeof n?JSON.parse(n):n:e}catch(n){return e}}function o(s,e){try{t.index.setStorageSync(s,JSON.stringify(e))}catch(n){}}function r(){const t=n(s,null);if(t&&"object"==typeof t&&Array.isArray(t.list)){const e={...t};e.list=(t.list||[]).map((t=>({id:t.id||c(),name:t.name||"玩家",avatar:t.avatar||"",color:t.color||l(),createdAt:t.createdAt||Date.now(),lastPlayedAt:t.lastPlayedAt||0})));const n=new Set(e.list.filter((t=>"Guest"===String(t.name||""))).map((t=>t.id)));n.size>0&&(e.list=e.list.filter((t=>!n.has(t.id))),n.has(e.currentId)&&(e.currentId=e.list[0]&&e.list[0].id||"")),e!==t&&o(s,e)}else o(s,{list:[],currentId:""});const r=n(e,null);if(r&&"object"==typeof r){if(!r._version||r._version<2){const t={...r};for(const s of Object.keys(t)){if(s.startsWith&&s.startsWith("_"))continue;const e=t[s];if(!e||"object"!=typeof e){t[s]={totals:{total:0,success:0,fail:0},days:{},rounds:[],agg:{}};continue}const n=e.totals&&"object"==typeof e.totals?e.totals:{total:0,success:0,fail:0},o=e.days&&"object"==typeof e.days?e.days:{},r=Array.isArray(e.rounds)?e.rounds:[],a=e.agg&&"object"==typeof e.agg?e.agg:{};t[s]={totals:n,days:o,rounds:r,agg:a}}t._version=2,o(e,t)}}else o(e,{_version:2})}function a(){return n(s,{list:[],currentId:""})}function i(t){o(s,t)}function c(){return Math.random().toString(36).slice(2,10)}function l(){const t=["#e2e8f0","#fde68a","#bbf7d0","#bfdbfe","#fecaca","#f5d0fe","#c7d2fe"];return t[Math.floor(Math.random()*t.length)]}exports.addUser=function(t,s="",e){var n;const o=a(),r=c(),d={id:r,name:t||`玩家${((null==(n=o.list)?void 0:n.length)||0)+1}`,avatar:s||"",color:e||l(),createdAt:Date.now(),lastPlayedAt:0};return o.list=(o.list||[]).concat([d]),o.currentId||(o.currentId=r),i(o),r},exports.allUsersWithStats=function(){const t=a().list||[],s=n(e,{});return t.map((t=>{const e=s[t.id]||{totals:{total:0,success:0,fail:0},days:{}},n=e.totals||{total:0,success:0,fail:0},o=n.total?Math.round(n.success/n.total*100):0,r=e.agg&&e.agg.bestTimeMs||void 0,a=e.agg&&e.agg.currentStreak||0,i=e.agg&&e.agg.longestStreak||0;return{id:t.id,name:t.name,totals:n,winRate:o,bestTimeMs:r,currentStreak:a,longestStreak:i}}))},exports.ensureInit=r,exports.getCurrentUser=function(){const t=a();return t.list.find((s=>s.id===t.currentId))},exports.getUsers=a,exports.pushRound=function(t){var s,r,l;const d=a().currentId;if(!d)return;const u=n(e,{_version:2});u._version||(u._version=2),u[d]||(u[d]={totals:{total:0,success:0,fail:0},days:{},rounds:[],agg:{}});const f=u[d],g=(new Date).toISOString().slice(0,10);f.days[g]||(f.days[g]={total:0,success:0,fail:0});const y="boolean"==typeof t,h=y?!!t:!!(null==t?void 0:t.success),v=Date.now(),m=y?null:{id:c(),ts:v,success:!!(null==t?void 0:t.success),timeMs:Number.isFinite(null==t?void 0:t.timeMs)?Math.max(0,Math.floor(t.timeMs)):void 0,hintUsed:!!(null==t?void 0:t.hintUsed),retries:Number.isFinite(null==t?void 0:t.retries)?Math.max(0,Math.floor(t.retries)):void 0,ops:Array.isArray(null==t?void 0:t.ops)?t.ops.slice(0,16):void 0,exprLen:Number.isFinite(null==t?void 0:t.exprLen)?Math.max(0,Math.floor(t.exprLen)):void 0,maxDepth:Number.isFinite(null==t?void 0:t.maxDepth)?Math.max(0,Math.floor(t.maxDepth)):void 0,faceUseHigh:"boolean"==typeof(null==t?void 0:t.faceUseHigh)?t.faceUseHigh:void 0,hand:(null==t?void 0:t.hand)&&Array.isArray(t.hand.cards)?{cards:t.hand.cards.map((t=>({rank:+t.rank,suit:t.suit})))}:void 0,solutionsCount:Number.isFinite(null==t?void 0:t.solutionsCount)?Math.max(0,Math.floor(t.solutionsCount)):void 0,expr:"string"==typeof(null==t?void 0:t.expr)?t.expr:void 0};if(f.totals.total+=1,f.days[g].total+=1,h?(f.totals.success+=1,f.days[g].success+=1):(f.totals.fail+=1,f.days[g].fail+=1),m){if(f.rounds.push(m),f.rounds.length>1e3&&f.rounds.splice(0,f.rounds.length-1e3),m.success&&Number.isFinite(m.timeMs)){const t=null==(s=f.agg)?void 0:s.bestTimeMs;f.agg.bestTimeMs=Number.isFinite(t)?Math.min(t,m.timeMs):m.timeMs}const t=(null==(r=f.agg)?void 0:r.currentStreak)||0;f.agg.currentStreak=h?t+1:0;const e=(null==(l=f.agg)?void 0:l.longestStreak)||0;f.agg.currentStreak>e&&(f.agg.longestStreak=f.agg.currentStreak)}o(e,u);try{const t=a(),s=(t.list||[]).find((t=>t.id===d));s&&(s.lastPlayedAt=Date.now(),i(t))}catch(p){}},exports.readStatsExtended=function(t){const s=n(e,{_version:2})[t]||{totals:{total:0,success:0,fail:0},days:{},rounds:[],agg:{}};return s.rounds||(s.rounds=[]),s.agg||(s.agg={}),s},exports.removeUser=function(t){const s=a();s.list=s.list.filter((s=>s.id!==t)),s.currentId===t&&(s.currentId=s.list[0]&&s.list[0].id||""),i(s)},exports.renameUser=function(t,s){const e=a(),n=e.list.find((s=>s.id===t));n&&(n.name=s,i(e))},exports.resetAllData=function(){try{t.index.clearStorageSync()}catch(s){}r()},exports.setUserAvatar=function(t,s){const e=a(),n=(e.list||[]).find((s=>s.id===t));n&&(n.avatar=s||"",i(e))},exports.switchUser=function(t){const s=a();s.list.find((s=>s.id===t))&&(s.currentId=t,i(s))},exports.touchLastPlayed=function(t){try{const s=a(),e=t||s.currentId;if(!e)return;const n=(s.list||[]).find((t=>t.id===e));n&&(n.lastPlayedAt=Date.now(),i(s))}catch(s){}};
